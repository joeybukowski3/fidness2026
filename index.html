<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Workout Tracker</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    * { -webkit-font-smoothing: antialiased; }
    body { margin: 0; padding: 0; background: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif; }

    /* Cards */
    .card { background: #ffffff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04); }
    .card.p-4 { padding: 16px; }
    .card.p-8 { padding: 32px; }
    .card.overflow-hidden { overflow: hidden; }

    /* Nav / top bar */
    .nav-bar { background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(0,0,0,0.08); }
    .top-bar { background: rgba(255,255,255,0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.08); }

    /* Phase badge */
    .phase-badge { font-size: 10px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; padding: 2px 8px; border-radius: 20px; white-space: nowrap; }

    /* Layout utilities */
    .flex { display: flex; }
    .flex-1 { flex: 1 1 0%; }
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .items-start { align-items: flex-start; }
    .justify-between { justify-content: space-between; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .text-left { text-align: left; }

    /* Gap */
    .gap-2 { gap: 8px; }
    .gap-3 { gap: 12px; }

    /* Margin/padding */
    .mb-3 { margin-bottom: 12px; }
    .mt-3 { margin-top: 12px; }

    /* Spacing stacks */
    .space-y-3 > * + * { margin-top: 12px; }
    .space-y-4 > * + * { margin-top: 16px; }
    .space-y-2 > * + * { margin-top: 8px; }

    /* Grid */
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .gap-3 { gap: 12px; }

    /* Hidden */
    .hidden { display: none; }

    /* Inputs */
    input[type=number], select { appearance: none; -webkit-appearance: none; outline: none; }
    input:focus, select:focus { outline: 2px solid #007AFF; outline-offset: -1px; }

    /* SVG icon color helper */
    .text-gray-400 { color: #8e8e93; }

    /* â”€â”€ Collapsible exercise card â”€â”€ */
    .exercise-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.07);
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .exercise-card.collapsed { box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .exercise-card.done { opacity: 0.55; }

    .exercise-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 14px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
    }
    .exercise-header:active { background: #f5f5f5; }

    .exercise-body {
      padding: 0 14px 14px;
      border-top: 1px solid #f2f2f7;
    }

    /* Done checkmark button */
    .done-btn {
      width: 28px; height: 28px;
      border-radius: 50%;
      border: 2px solid #d1d1d6;
      background: none;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .done-btn.checked { background: #34c759; border-color: #34c759; }
    .done-btn svg { display: none; }
    .done-btn.checked svg { display: block; }

    /* Phase section */
    .phase-section { margin-bottom: 4px; }
    .phase-section-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 4px 6px;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      border: none; background: none; width: 100%; text-align: left;
    }
    .phase-section-header:active { opacity: 0.7; }

    .phase-section-exercises {
      display: flex; flex-direction: column; gap: 8px;
    }
    .phase-section-exercises.hidden-section { display: none; }

    /* Collapse chevron animation */
    .chevron-icon {
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    .chevron-icon.open { transform: rotate(0deg); }
    .chevron-icon.closed { transform: rotate(-90deg); }

    /* Progress bar inside phase header */
    .phase-progress-pill {
      font-size: 11px; font-weight: 600;
      padding: 2px 8px; border-radius: 20px;
      background: #e5e5ea; color: #636366;
    }
    .phase-progress-pill.all-done { background: #d4f5dc; color: #1a7a32; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const DAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const DAY_KEYS = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
    const STORAGE_KEY = 'workoutAppState';
    const APP_VERSION = 1;

    const DAILY_STRETCHES = [
      '90/90 Hip Switch',
      'Thread the Needle',
      "World's Greatest Stretch (with T-Spine Rotation)",
      'Terminal Knee Extensions (TKEs) - Standing'
    ];

    const getPhaseStyle = (phase) => {
      if (!phase) return { bg: '#e5e5ea', text: '#636366' };
      const lower = phase.toLowerCase();
      if (lower.includes('pre') || lower.includes('stretch')) return { bg: '#e8f5e9', text: '#2e7d32' };
      if (lower.includes('main')) return { bg: '#e3f2fd', text: '#1565c0' };
      if (lower.includes('bonus')) return { bg: '#fff3e0', text: '#e65100' };
      return { bg: '#e5e5ea', text: '#636366' };
    };

    // â”€â”€ Icons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const Calendar = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
    );
    const TrendingUp = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
    );
    const Dumbbell = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6.5 6.5 11 11"></path><path d="m21 21-1-1"></path><path d="m3 3 1 1"></path><path d="m18 22 4-4"></path><path d="m2 6 4-4"></path><path d="m3 10 7-7"></path><path d="m14 21 7-7"></path></svg>
    );
    const Menu = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    );
    const Download = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
    );
    const Upload = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
    );
    const ChevronDown = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>
    );
    const ChevronUp = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>
    );
    const ArrowUp = ({ size=24, className="" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
    );
    const CheckIcon = ({ size=14 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
    );

    // â”€â”€ CSV helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const parseCsv = (text) => {
      const lines = text.split(/\r?\n/).filter(Boolean);
      if (lines.length === 0) return [];
      const headers = parseCsvLine(lines[0]);
      return lines.slice(1).map(line => {
        const values = parseCsvLine(line);
        const row = {};
        headers.forEach((h, i) => { row[h] = values[i] ?? ''; });
        return row;
      });
    };
    const parseCsvLine = (line) => {
      const result = []; let current = ''; let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"' && line[i+1] === '"') { current += '"'; i++; continue; }
        if (ch === '"') { inQuotes = !inQuotes; continue; }
        if (ch === ',' && !inQuotes) { result.push(current); current = ''; continue; }
        current += ch;
      }
      result.push(current);
      return result.map(v => v.trim());
    };

    const toLocalDateString = (date) => {
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    };
    const parseLocalDate = (val) => {
      const [y,m,d] = val.split('-').map(Number);
      return new Date(y, m-1, d);
    };
    const diffInDays = (start, end) => {
      const s = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 12);
      const e = new Date(end.getFullYear(), end.getMonth(), end.getDate(), 12);
      return Math.floor((e - s) / (24*60*60*1000));
    };
    const slugify = (v) => v.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    const getExerciseEmoji = (name) => {
      const l = name.toLowerCase();
      if (l.includes('walk')||l.includes('bike')||l.includes('run')) return 'ðŸƒ';
      if (l.includes('yoga')||l.includes('stretch')||l.includes('mobility')||l.includes('foam')||l.includes('roll')||l.includes('bretzel')||l.includes('pigeon')||l.includes('lizard')||l.includes('twist')) return 'ðŸ§˜';
      if (l.includes('bench')||l.includes('press')) return 'ðŸ‹ï¸';
      if (l.includes('deadlift')||l.includes('squat')) return 'ðŸ’ª';
      if (l.includes('curl')) return 'ðŸ’ª';
      if (l.includes('row')||l.includes('pull')) return 'ðŸš£';
      if (l.includes('leg')||l.includes('calf')) return 'ðŸ¦µ';
      if (l.includes('shoulder')||l.includes('delt')) return 'ðŸ’ª';
      if (l.includes('tricep')) return 'ðŸ’ª';
      if (l.includes('glute')||l.includes('bridge')||l.includes('lateral')) return 'ðŸ‘';
      if (l.includes('core')||l.includes('bug')||l.includes('plank')) return 'ðŸ”¥';
      return 'ðŸ’ª';
    };

    // â”€â”€ Main Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function WorkoutTracker() {
      const [tab, setTab] = useState('today');
      const [programs, setPrograms] = useState([]);
      const [programManifest, setProgramManifest] = useState(null);
      const [programBasePath, setProgramBasePath] = useState('');
      const [programDayCache, setProgramDayCache] = useState({});
      const [programLoadError, setProgramLoadError] = useState('');

      const [activeProgramId, setActiveProgramId] = useState('program-1');
      const [programStartDate, setProgramStartDate] = useState('');
      const [currentWeek, setCurrentWeek] = useState(1);
      const [completedDays, setCompletedDays] = useState({});
      const [lastOpenedDate, setLastOpenedDate] = useState('');

      const [workoutLogs, setWorkoutLogs] = useState([]);
      const [bodyweightLogs, setBodyweightLogs] = useState([]);
      const [history, setHistory] = useState([]);
      const [todayWeight, setTodayWeight] = useState('');
      const [todayInputs, setTodayInputs] = useState({});

      // â”€â”€ NEW: collapse state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // collapsedExercises: { [exName]: bool }  â€” true = collapsed
      const [collapsedExercises, setCollapsedExercises] = useState({});
      // doneExercises: { [exName]: bool }  â€” true = marked done (also collapses)
      const [doneExercises, setDoneExercises] = useState({});
      // collapsedPhases: { [phaseName]: bool }  â€” true = collapsed
      const [collapsedPhases, setCollapsedPhases] = useState({});
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const [expandedExercises, setExpandedExercises] = useState({});
      const [expandedHistory, setExpandedHistory] = useState({});
      const [showMenu, setShowMenu] = useState(false);
      const [showStretches, setShowStretches] = useState(false);
      const [viewWeek, setViewWeek] = useState(1);
      const fileInputRef = useRef(null);

      const today = new Date();
      const todayStr = toLocalDateString(today);
      const todayDayKey = DAY_KEYS[today.getDay()];
      const todayDayName = DAYS[today.getDay()];

      // Load program index
      useEffect(() => {
        const load = async () => {
          try {
            const res = await fetch('data/programs/index.json');
            if (!res.ok) throw new Error();
            const data = await res.json();
            const list = data.programs || [];
            setPrograms(list);
            if (list.length > 0) setActiveProgramId(list[0].id);
          } catch {
            setPrograms([{ id:'program-1', name:'Program 1', path:'data/programs/program-1/program.json' }]);
            setProgramLoadError('Unable to load program library.');
          }
        };
        load();
      }, []);

      // Load saved state
      useEffect(() => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.version === APP_VERSION) {
            setActiveProgramId(data.activeProgramId || 'program-1');
            setProgramStartDate(data.programStartDate || todayStr);
            setCurrentWeek(data.currentWeek || 1);
            setCompletedDays(data.completedDays || {});
            setLastOpenedDate(data.lastOpenedDate || todayStr);
            setWorkoutLogs(data.workoutLogs || []);
            setBodyweightLogs(data.bodyweightLogs || []);
            setHistory(data.history || []);
            setViewWeek(data.currentWeek || 1);
            return;
          }
        }
        setProgramStartDate(todayStr);
        setLastOpenedDate(todayStr);
      }, [todayStr]);

      // Save state
      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
          version:APP_VERSION, activeProgramId, programStartDate, currentWeek,
          completedDays, lastOpenedDate, workoutLogs, bodyweightLogs, history
        }));
      }, [activeProgramId, programStartDate, currentWeek, completedDays, lastOpenedDate, workoutLogs, bodyweightLogs, history]);

      // Update week from start date
      useEffect(() => {
        if (!programStartDate) return;
        setLastOpenedDate(todayStr);
        const startDate = parseLocalDate(programStartDate);
        const daysSinceStart = diffInDays(startDate, today);
        if (daysSinceStart < 0) { setCurrentWeek(1); setViewWeek(1); return; }
        const durationWeeks = programManifest?.durationWeeks || 6;
        const calc = Math.min(durationWeeks, Math.floor(daysSinceStart/7)+1);
        setCurrentWeek(calc); setViewWeek(calc);
      }, [programStartDate, todayStr, programManifest]);

      // Load program manifest + all days
      useEffect(() => {
        if (!activeProgramId || programs.length === 0) return;
        const selected = programs.find(p => p.id === activeProgramId) || programs[0];
        if (!selected) return;
        const load = async () => {
          try {
            const res = await fetch(selected.path);
            if (!res.ok) throw new Error();
            const manifest = await res.json();
            setProgramManifest(manifest);
            const base = selected.path.split('/').slice(0,-1).join('/');
            setProgramBasePath(base);
            setProgramDayCache({});
            await loadAllDays(manifest, base);
          } catch {
            setProgramManifest(null);
            setProgramLoadError(`Unable to load: ${selected.name}`);
          }
        };
        load();
      }, [activeProgramId, programs]);

      const loadAllDays = async (manifest, basePath) => {
        const cache = {};
        await Promise.all(DAY_KEYS.map(async (dayKey) => {
          const fileName = manifest.fileMap?.[dayKey];
          if (!fileName) { cache[dayKey] = []; return; }
          try {
            const res = await fetch(`${basePath}/${fileName}`);
            if (!res.ok) throw new Error();
            const rows = parseCsv(await res.text());
            cache[dayKey] = rows.filter(r => r.Exercise);
          } catch { cache[dayKey] = []; }
        }));
        setProgramDayCache(cache);
      };

      // Default inputs
      useEffect(() => {
        const exercises = (programDayCache[todayDayKey] || []).map(r => r.Exercise);
        const defaults = {};
        exercises.forEach(ex => { if (!todayInputs[ex]) defaults[ex] = { weight:'', reps:'10' }; });
        if (Object.keys(defaults).length > 0) setTodayInputs(prev => ({ ...prev, ...defaults }));
      }, [programDayCache, todayDayKey]);

      const getCompletedForProgram = () => completedDays?.[activeProgramId] || {};
      const isCardioExercise = (name) => { const l=name.toLowerCase(); return l.includes('walk')||l.includes('bike')||l.includes('run'); };
      const getLastWorkout = (id) => { const logs=workoutLogs.filter(l=>l.programId===activeProgramId&&l.exerciseId===id); return logs.length>0?logs[logs.length-1]:null; };
      const getAllWorkouts = (id) => workoutLogs.filter(l=>l.programId===activeProgramId&&l.exerciseId===id).sort((a,b)=>new Date(b.date)-new Date(a.date));

      const calculateGain = (id) => {
        const logs = getAllWorkouts(id).slice().reverse();
        if (logs.length < 2) return null;
        const first = logs[0]; const last = logs[logs.length-1];
        const gain = ((last.weight*last.reps - first.weight*first.reps)/(first.weight*first.reps)*100).toFixed(1);
        return { first, last, gain: parseFloat(gain) };
      };

      const getMissedDays = () => {
        if (!programStartDate) return [];
        const startDate = parseLocalDate(programStartDate);
        const daysSinceStart = diffInDays(startDate, today);
        if (daysSinceStart <= 0) return [];
        const completed = getCompletedForProgram();
        const missed = [];
        for (let i=0; i<daysSinceStart; i++) {
          const date = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate()+i);
          const ds = toLocalDateString(date);
          if (!completed[ds]) missed.push(ds);
        }
        return missed;
      };

      const logWorkout = () => {
        const exercises = (programDayCache[todayDayKey] || []).map(r => r.Exercise);
        const logs = exercises.map(exName => {
          const isCardio = isCardioExercise(exName);
          return { exerciseId:slugify(exName), exerciseName:exName, weight:parseFloat(todayInputs[exName]?.weight||0), reps:isCardio?parseFloat(todayInputs[exName]?.reps||0):parseInt(todayInputs[exName]?.reps||0), date:todayStr, week:currentWeek, dayOfWeek:todayDayKey, isCardio, programId:activeProgramId };
        }).filter(l=>l.weight>0&&l.reps>0);

        const updated = { ...(getCompletedForProgram()), [todayStr]:true };
        setCompletedDays(prev => ({ ...prev, [activeProgramId]:updated }));

        if (logs.length > 0) {
          setWorkoutLogs(prev => [...prev,...logs]);
          setTodayInputs({});
          alert('Workout logged!');
        } else {
          alert('Day marked complete.');
        }
      };

      const exportData = () => {
        const data = { version:APP_VERSION, activeProgramId, programStartDate, currentWeek, completedDays, lastOpenedDate, workoutLogs, bodyweightLogs, history, exportDate:new Date().toISOString() };
        const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=`workout-backup-${todayStr}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url); setShowMenu(false); alert('Exported.');
      };

      const importData = (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (confirm('Replace all current data?')) {
              setActiveProgramId(data.activeProgramId||'program-1');
              setProgramStartDate(data.programStartDate||todayStr);
              setCurrentWeek(data.currentWeek||1);
              setCompletedDays(data.completedDays||{});
              setLastOpenedDate(data.lastOpenedDate||todayStr);
              setWorkoutLogs(data.workoutLogs||[]);
              setBodyweightLogs(data.bodyweightLogs||[]);
              setHistory(data.history||[]);
              setViewWeek(data.currentWeek||1);
              setShowMenu(false); alert('Imported.');
            }
          } catch { alert('Error importing data.'); }
        };
        reader.readAsText(file); event.target.value='';
      };

      // â”€â”€ Toggle helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const toggleExercise = (exName) => {
        setCollapsedExercises(prev => ({ ...prev, [exName]: !prev[exName] }));
      };

      const markExerciseDone = (exName, e) => {
        e.stopPropagation();
        const nowDone = !doneExercises[exName];
        setDoneExercises(prev => ({ ...prev, [exName]: nowDone }));
        // Auto-collapse when marked done
        if (nowDone) setCollapsedExercises(prev => ({ ...prev, [exName]: true }));
        else setCollapsedExercises(prev => ({ ...prev, [exName]: false }));
      };

      const togglePhase = (phaseName) => {
        setCollapsedPhases(prev => ({ ...prev, [phaseName]: !prev[phaseName] }));
      };

      // â”€â”€ RENDER TODAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const renderToday = () => {
        const exercises = programDayCache[todayDayKey] || [];
        const completed = getCompletedForProgram()[todayStr];
        const missedDays = getMissedDays();

        // Group by phase
        const byPhase = {};
        exercises.forEach(row => {
          const phase = row.Phase || 'Exercises';
          if (!byPhase[phase]) byPhase[phase] = [];
          byPhase[phase].push(row);
        });

        return (
          <div className="space-y-3">
            {/* Program status */}
            <div className="card p-4">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,letterSpacing:'0.05em',textTransform:'uppercase'}}>Active Program</p>
                  <p style={{color:'#1c1c1e',fontSize:16,fontWeight:600,marginTop:2}}>{programManifest?.name||'Loading...'}</p>
                </div>
                <div className="text-right">
                  <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,letterSpacing:'0.05em',textTransform:'uppercase'}}>Progress</p>
                  <p style={{color:'#1c1c1e',fontSize:14,fontWeight:500,marginTop:2}}>Week {currentWeek} Â· {todayDayName}</p>
                </div>
              </div>
              <div className="flex gap-2 mb-3">
                <button onClick={() => setTab('today')} style={{flex:1,padding:'8px 0',background:'#007AFF',borderRadius:10,color:'white',fontSize:13,fontWeight:600,border:'none'}}>Resume</button>
                <button onClick={() => { setProgramStartDate(todayStr); setCurrentWeek(1); setViewWeek(1); setCompletedDays(prev=>({...prev,[activeProgramId]:{}})); }} style={{flex:1,padding:'8px 0',background:'#f2f2f7',borderRadius:10,color:'#1c1c1e',fontSize:13,fontWeight:600,border:'none'}}>Restart</button>
              </div>
              <div className="flex justify-between" style={{fontSize:12,color:'#8e8e93'}}>
                <span>Started {programStartDate||'Not set'}</span>
                {missedDays.length>0 && <span style={{color:'#ff9500'}}>âš  {missedDays.length} missed</span>}
              </div>
            </div>

            {/* Bodyweight */}
            <div className="card p-4">
              <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,letterSpacing:'0.05em',textTransform:'uppercase',marginBottom:8}}>Bodyweight Today</p>
              <div className="flex gap-2">
                <input type="number" step="0.1" value={todayWeight} onChange={e=>setTodayWeight(e.target.value)} placeholder="Weight (lbs)" style={{flex:1,background:'#f2f2f7',border:'none',borderRadius:10,padding:'10px 12px',fontSize:15,color:'#1c1c1e'}} />
                <button onClick={() => { if(todayWeight&&parseFloat(todayWeight)>0){setBodyweightLogs(prev=>[...prev,{weight:parseFloat(todayWeight),date:todayStr}]);setTodayWeight('');alert('Bodyweight logged.');} }} style={{padding:'10px 18px',background:'#34c759',borderRadius:10,color:'white',fontSize:14,fontWeight:600,border:'none'}}>Log</button>
              </div>
            </div>

            {/* Day header */}
            <div className="flex items-center justify-between" style={{paddingTop:4}}>
              <h2 style={{color:'#1c1c1e',fontSize:20,fontWeight:700}}>{todayDayName} â€” Week {currentWeek}</h2>
              {completed && <span style={{color:'#34c759',fontSize:13,fontWeight:600}}>âœ“ Completed</span>}
            </div>

            {exercises.length === 0 ? (
              <div className="card p-8 text-center">
                <p style={{color:'#8e8e93',marginBottom:16}}>No workout scheduled for {todayDayName}</p>
                <button onClick={logWorkout} style={{padding:'10px 24px',background:'#34c759',borderRadius:10,color:'white',fontSize:14,fontWeight:600,border:'none'}}>Mark Day Complete</button>
              </div>
            ) : (
              <>
                {/* â”€â”€ Phase sections â”€â”€ */}
                {Object.entries(byPhase).map(([phaseName, phaseRows]) => {
                  const phaseStyle = getPhaseStyle(phaseName);
                  const isPhaseCollapsed = !!collapsedPhases[phaseName];
                  const doneCount = phaseRows.filter(r => doneExercises[r.Exercise]).length;
                  const allDone = doneCount === phaseRows.length;

                  return (
                    <div key={phaseName} className="phase-section">
                      {/* Phase header â€” clickable to collapse whole section */}
                      <button className="phase-section-header" onClick={() => togglePhase(phaseName)}>
                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                          <span className="phase-badge" style={{background:phaseStyle.bg,color:phaseStyle.text,fontSize:11}}>
                            {phaseName.replace(' (Optional)','').replace('Pre-Workout ','')}
                          </span>
                          <span style={{fontSize:12,color:'#8e8e93'}}>{phaseRows.length} exercise{phaseRows.length!==1?'s':''}</span>
                          {doneCount > 0 && (
                            <span className={`phase-progress-pill ${allDone?'all-done':''}`}>
                              {allDone ? 'âœ“ All done' : `${doneCount}/${phaseRows.length}`}
                            </span>
                          )}
                        </div>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"
                          className={`chevron-icon ${isPhaseCollapsed?'closed':'open'}`}>
                          <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                      </button>

                      {/* Phase exercises */}
                      {!isPhaseCollapsed && (
                        <div className="phase-section-exercises">
                          {phaseRows.map((row, idx) => {
                            const exName = row.Exercise;
                            const exerciseId = slugify(exName);
                            const last = getLastWorkout(exerciseId);
                            const isCardio = isCardioExercise(exName);
                            const isCollapsed = !!collapsedExercises[exName];
                            const isDone = !!doneExercises[exName];

                            return (
                              <div key={idx} className={`exercise-card ${isCollapsed?'collapsed':''} ${isDone?'done':''}`}>
                                {/* Exercise header row */}
                                <button className="exercise-header" onClick={() => toggleExercise(exName)}>
                                  {/* Done checkmark */}
                                  <div
                                    className={`done-btn ${isDone?'checked':''}`}
                                    onClick={(e) => markExerciseDone(exName, e)}
                                    title={isDone?'Mark undone':'Mark done'}
                                  >
                                    <CheckIcon size={12} />
                                  </div>

                                  <span style={{fontSize:20,flexShrink:0}}>{getExerciseEmoji(exName)}</span>

                                  <div style={{flex:1,minWidth:0}}>
                                    <p style={{color: isDone?'#8e8e93':'#1c1c1e', fontWeight:600, fontSize:14, textDecoration: isDone?'line-through':'none', margin:0}}>{exName}</p>
                                    {(row.Sets||row.Reps) && (
                                      <p style={{color:'#8e8e93',fontSize:11,margin:'2px 0 0'}}>{row.Sets&&`${row.Sets} sets`}{row.Sets&&row.Reps&&' Ã— '}{row.Reps&&row.Reps}</p>
                                    )}
                                    {!isCollapsed && last && (
                                      <p style={{color:'#007AFF',fontSize:11,margin:'2px 0 0'}}>
                                        Last: {last.weight}{isCardio?'Â°':' lbs'} Ã— {last.reps} {isCardio?'mi':'reps'}
                                      </p>
                                    )}
                                  </div>

                                  {/* Collapse chevron */}
                                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#c7c7cc" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"
                                    className={`chevron-icon ${isCollapsed?'closed':'open'}`}>
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                  </svg>
                                </button>

                                {/* Exercise body â€” hidden when collapsed */}
                                {!isCollapsed && (
                                  <div className="exercise-body">
                                    {last && (
                                      <p style={{color:'#007AFF',fontSize:12,marginBottom:10}}>
                                        Last: {last.weight}{isCardio?'Â°':' lbs'} Ã— {last.reps} {isCardio?'mi':'reps'}
                                      </p>
                                    )}
                                    <div className="flex gap-2">
                                      <input
                                        type="number"
                                        placeholder={isCardio?"Incline":"Weight (lbs)"}
                                        value={todayInputs[exName]?.weight||''}
                                        onChange={e => setTodayInputs(prev=>({...prev,[exName]:{...prev[exName],weight:e.target.value}}))}
                                        style={{flex:1,background:'#f2f2f7',border:'none',borderRadius:10,padding:'10px 12px',fontSize:15,color:'#1c1c1e'}}
                                      />
                                      {isCardio ? (
                                        <input
                                          type="number" step="0.1" placeholder="Distance"
                                          value={todayInputs[exName]?.reps||''}
                                          onChange={e => setTodayInputs(prev=>({...prev,[exName]:{...prev[exName],reps:e.target.value}}))}
                                          style={{flex:1,background:'#f2f2f7',border:'none',borderRadius:10,padding:'10px 12px',fontSize:15,color:'#1c1c1e'}}
                                        />
                                      ) : (
                                        <select
                                          value={todayInputs[exName]?.reps||'10'}
                                          onChange={e => setTodayInputs(prev=>({...prev,[exName]:{...prev[exName],reps:e.target.value}}))}
                                          style={{flex:1,background:'#f2f2f7',border:'none',borderRadius:10,padding:'10px 12px',fontSize:15,color:'#1c1c1e'}}
                                        >
                                          {[...Array(40)].map((_,i)=><option key={i+1} value={i+1}>{i+1} reps</option>)}
                                        </select>
                                      )}
                                    </div>
                                    {row.Notes_Substitutes && (
                                      <p style={{color:'#8e8e93',fontSize:12,marginTop:8,fontStyle:'italic'}}>{row.Notes_Substitutes}</p>
                                    )}
                                    {/* Quick-done button inside body */}
                                    <button
                                      onClick={(e) => markExerciseDone(exName, e)}
                                      style={{marginTop:10,width:'100%',padding:'8px 0',background: isDone?'#f2f2f7':'#34c759',borderRadius:8,color: isDone?'#8e8e93':'white',fontSize:13,fontWeight:600,border:'none'}}
                                    >
                                      {isDone ? 'â†© Undo' : 'âœ“ Mark Done & Collapse'}
                                    </button>
                                  </div>
                                )}
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })}

                <button onClick={logWorkout} style={{width:'100%',padding:'14px 0',background:'#007AFF',borderRadius:12,color:'white',fontSize:16,fontWeight:700,border:'none',marginTop:4}}>
                  Complete Workout
                </button>

                {/* Daily Stretches */}
                <div className="card overflow-hidden">
                  <button onClick={() => setShowStretches(!showStretches)} style={{width:'100%',padding:'14px 16px',display:'flex',justifyContent:'space-between',alignItems:'center',background:'none',border:'none'}}>
                    <span style={{color:'#1c1c1e',fontWeight:600,fontSize:15}}>ðŸ§˜ Daily Stretches</span>
                    {showStretches ? <ChevronUp size={16} className="text-gray-400" /> : <ChevronDown size={16} className="text-gray-400" />}
                  </button>
                  {showStretches && (
                    <div style={{padding:'0 16px 16px',borderTop:'1px solid #f2f2f7'}}>
                      {DAILY_STRETCHES.map((stretch,idx) => (
                        <div key={idx} style={{display:'flex',gap:10,marginTop:10}}>
                          <span style={{color:'#8e8e93',fontSize:13,minWidth:16}}>{idx+1}.</span>
                          <span style={{color:'#3c3c43',fontSize:13}}>{stretch}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </>
            )}
          </div>
        );
      };

      // â”€â”€ RENDER SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const renderSchedule = () => {
        const duration = programManifest?.durationWeeks||6;
        return (
          <div className="space-y-4">
            <div className="card p-4">
              <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,letterSpacing:'0.05em',textTransform:'uppercase',marginBottom:4}}>Current Program</p>
              <p style={{color:'#1c1c1e',fontSize:20,fontWeight:700}}>{programManifest?.name||'Loading...'}</p>
              <p style={{color:'#8e8e93',fontSize:13,marginTop:2}}>{duration}-week program</p>
              <div className="flex items-center gap-2 mt-3" style={{flexWrap:'wrap'}}>
                <span style={{fontSize:12,color:'#8e8e93'}}>You are on:</span>
                <span style={{background:'#007AFF',color:'white',borderRadius:20,padding:'2px 10px',fontSize:12,fontWeight:600}}>Week {currentWeek}</span>
              </div>
            </div>
            {DAY_KEYS.map((dayKey, idx) => {
              const rows = programDayCache[dayKey]||[];
              const isToday = dayKey===todayDayKey;
              const dayName = DAYS[idx];
              const byPhase = {};
              rows.forEach(row => { const p=row.Phase||'Exercises'; if(!byPhase[p])byPhase[p]=[]; byPhase[p].push(row); });
              return (
                <div key={dayKey} className="card overflow-hidden" style={{border:isToday?'2px solid #007AFF':'none'}}>
                  <div style={{padding:'12px 16px',borderBottom:rows.length>0?'1px solid #f2f2f7':'none',display:'flex',alignItems:'center',justifyContent:'space-between'}}>
                    <div style={{display:'flex',alignItems:'center',gap:8}}>
                      <h3 style={{color:'#1c1c1e',fontWeight:700,fontSize:16}}>{dayName}</h3>
                      {isToday&&<span style={{background:'#007AFF',color:'white',borderRadius:20,padding:'1px 8px',fontSize:11,fontWeight:700}}>TODAY</span>}
                    </div>
                    <span style={{color:'#8e8e93',fontSize:12}}>{rows.length>0?`${rows.length} exercises`:'Rest day'}</span>
                  </div>
                  {rows.length===0 ? (
                    <div style={{padding:'12px 16px'}}><p style={{color:'#8e8e93',fontSize:14}}>ðŸ˜´ Rest & Recovery</p></div>
                  ) : (
                    <div style={{padding:'8px 16px 16px'}}>
                      {Object.entries(byPhase).map(([phase,phaseRows]) => {
                        const ps = getPhaseStyle(phase);
                        return (
                          <div key={phase} style={{marginTop:12}}>
                            <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:8}}>
                              <span className="phase-badge" style={{background:ps.bg,color:ps.text}}>{phase}</span>
                            </div>
                            <div style={{display:'flex',flexDirection:'column',gap:6}}>
                              {phaseRows.map((row,i) => (
                                <div key={i} style={{display:'flex',alignItems:'flex-start',gap:10,padding:'8px 10px',background:'#f9f9f9',borderRadius:8}}>
                                  <span style={{fontSize:16,flexShrink:0}}>{getExerciseEmoji(row.Exercise)}</span>
                                  <div style={{flex:1,minWidth:0}}>
                                    <p style={{color:'#1c1c1e',fontSize:13,fontWeight:500,marginBottom:2}}>{row.Exercise}</p>
                                    {(row.Sets||row.Reps)&&<p style={{color:'#8e8e93',fontSize:12}}>{row.Sets&&`${row.Sets} sets`}{row.Sets&&row.Reps&&' Ã— '}{row.Reps&&row.Reps}{row.Rest_Seconds&&row.Rest_Seconds!=='0'&&` Â· ${row.Rest_Seconds}s rest`}</p>}
                                    {row.Notes_Substitutes&&<p style={{color:'#8e8e93',fontSize:11,marginTop:2,fontStyle:'italic'}}>{row.Notes_Substitutes}</p>}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        );
      };

      // â”€â”€ RENDER STRENGTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const renderStrength = () => {
        const exercisesWithData = [...new Set(workoutLogs.filter(l=>l.programId===activeProgramId).map(l=>l.exerciseId))];
        return (
          <div className="space-y-3">
            <h2 style={{color:'#1c1c1e',fontSize:22,fontWeight:700}}>Strength Progress</h2>
            {exercisesWithData.length===0 ? (
              <div className="card p-8 text-center"><p style={{color:'#8e8e93'}}>No workout data yet. Start logging!</p></div>
            ) : exercisesWithData.map((exerciseId,idx) => {
              const allLogs = getAllWorkouts(exerciseId);
              const last = allLogs[0]; const progress = calculateGain(exerciseId);
              const isExpanded = expandedExercises[exerciseId];
              if (!last||!progress) return null;
              const { first, gain } = progress; const isCardio = last.isCardio;
              return (
                <div key={idx} className="card overflow-hidden">
                  <div style={{padding:16}}>
                    <div className="flex items-center gap-2 mb-3">
                      <span style={{fontSize:22}}>{getExerciseEmoji(last.exerciseName)}</span>
                      <h3 style={{color:'#1c1c1e',fontWeight:600,fontSize:15,flex:1}}>{last.exerciseName}</h3>
                      <button onClick={() => setExpandedExercises(prev=>({...prev,[exerciseId]:!prev[exerciseId]}))} style={{background:'none',border:'none',padding:4}}>
                        {isExpanded?<ChevronUp size={16} color="#8e8e93"/>:<ChevronDown size={16} color="#8e8e93"/>}
                      </button>
                    </div>
                    <div className="grid grid-cols-2 gap-3" style={{marginBottom:12}}>
                      <div style={{background:'#f2f2f7',borderRadius:10,padding:'10px 12px'}}>
                        <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,marginBottom:4}}>BASELINE</p>
                        <p style={{color:'#1c1c1e',fontSize:14,fontWeight:500}}>{first.weight}{isCardio?'Â°':'lbs'} Ã— {first.reps}</p>
                      </div>
                      <div style={{background:'#f2f2f7',borderRadius:10,padding:'10px 12px'}}>
                        <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,marginBottom:4}}>CURRENT</p>
                        <p style={{color:'#1c1c1e',fontSize:14,fontWeight:500}}>{last.weight}{isCardio?'Â°':'lbs'} Ã— {last.reps}</p>
                      </div>
                    </div>
                    <div style={{display:'flex',alignItems:'center',gap:6,color:gain>0?'#34c759':gain<0?'#ff3b30':'#8e8e93'}}>
                      {gain>0&&<ArrowUp size={14}/>}
                      <span style={{fontWeight:700,fontSize:16}}>{gain>0?'+':''}{gain}%</span>
                      <span style={{fontSize:13,color:'#8e8e93'}}>volume change</span>
                    </div>
                  </div>
                  {isExpanded&&(
                    <div style={{borderTop:'1px solid #f2f2f7',padding:16,background:'#fafafa'}}>
                      <p style={{color:'#8e8e93',fontSize:11,fontWeight:700,letterSpacing:'0.05em',textTransform:'uppercase',marginBottom:10}}>History</p>
                      {allLogs.map((log,i)=>(
                        <div key={i} style={{display:'flex',justifyContent:'space-between',padding:'6px 0',borderBottom:i<allLogs.length-1?'1px solid #f2f2f7':'none'}}>
                          <span style={{color:'#8e8e93',fontSize:13}}>{log.date} Â· W{log.week}</span>
                          <span style={{color:'#1c1c1e',fontSize:13,fontWeight:500}}>{log.weight}{log.isCardio?'Â°':'lbs'} Ã— {log.reps}</span>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            })}
          </div>
        );
      };

      // â”€â”€ RENDER TRENDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const renderTrends = () => {
        const sortedLogs = [...bodyweightLogs].sort((a,b)=>new Date(a.date)-new Date(b.date));
        return (
          <div className="space-y-3">
            <h2 style={{color:'#1c1c1e',fontSize:22,fontWeight:700}}>Bodyweight Trends</h2>
            {sortedLogs.length===0 ? (
              <div className="card p-8 text-center"><p style={{color:'#8e8e93'}}>No bodyweight data yet</p></div>
            ) : (
              <>
                <div className="card p-4">
                  <div style={{height:160,position:'relative'}}>
                    <svg viewBox="0 0 300 150" style={{width:'100%',height:'100%'}}>
                      {sortedLogs.map((log,i)=>{
                        if(i===0)return null;
                        const prev=sortedLogs[i-1];
                        const x1=(i-1)*(300/(sortedLogs.length-1)), x2=i*(300/(sortedLogs.length-1));
                        const minW=Math.min(...sortedLogs.map(l=>l.weight)), maxW=Math.max(...sortedLogs.map(l=>l.weight)), range=maxW-minW||1;
                        const y1=150-((prev.weight-minW)/range*130+10), y2=150-((log.weight-minW)/range*130+10);
                        return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} stroke="#007AFF" strokeWidth="2.5" strokeLinecap="round"/>;
                      })}
                      {sortedLogs.map((log,i)=>{
                        const x=sortedLogs.length>1?i*(300/(sortedLogs.length-1)):150;
                        const minW=Math.min(...sortedLogs.map(l=>l.weight)), maxW=Math.max(...sortedLogs.map(l=>l.weight)), range=maxW-minW||1;
                        const y=150-((log.weight-minW)/range*130+10);
                        return <circle key={i} cx={x} cy={y} r="4" fill="#007AFF"/>;
                      })}
                    </svg>
                  </div>
                </div>
                <div className="space-y-2">
                  {[...sortedLogs].reverse().map((log,i)=>(
                    <div key={i} className="card" style={{padding:'12px 16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                      <span style={{color:'#8e8e93',fontSize:14}}>{log.date}</span>
                      <span style={{color:'#1c1c1e',fontSize:16,fontWeight:600}}>{log.weight} lbs</span>
                    </div>
                  ))}
                </div>
              </>
            )}
          </div>
        );
      };

      // â”€â”€ RENDER HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const renderHistory = () => (
        <div className="space-y-3">
          <h2 style={{color:'#1c1c1e',fontSize:22,fontWeight:700}}>Program History</h2>
          {history.length===0 ? (
            <div className="card p-8 text-center"><p style={{color:'#8e8e93'}}>No completed programs yet.</p></div>
          ) : history.map(item=>{
            const isExpanded=expandedHistory[item.id];
            return (
              <div key={item.id} className="card overflow-hidden">
                <button onClick={()=>setExpandedHistory(prev=>({...prev,[item.id]:!prev[item.id]}))} style={{width:'100%',padding:'14px 16px',display:'flex',alignItems:'center',justifyContent:'space-between',background:'none',border:'none'}}>
                  <div className="text-left">
                    <p style={{color:'#1c1c1e',fontWeight:600,fontSize:15}}>{item.programName}</p>
                    <p style={{color:'#8e8e93',fontSize:12,marginTop:2}}>{item.startDate} â†’ {item.endDate}</p>
                  </div>
                  {isExpanded?<ChevronUp size={16} color="#8e8e93"/>:<ChevronDown size={16} color="#8e8e93"/>}
                </button>
                {isExpanded&&<div style={{borderTop:'1px solid #f2f2f7',padding:'12px 16px',background:'#fafafa'}}><p style={{color:'#3c3c43',fontSize:13}}>Completed: {item.completedDays}/{item.totalDays} days ({item.completionRate}%)</p></div>}
              </div>
            );
          })}
        </div>
      );

      return (
        <div style={{minHeight:'100vh',background:'#f2f2f7',paddingBottom:80}}>
          {/* Top bar */}
          <div className="top-bar" style={{position:'sticky',top:0,zIndex:50}}>
            <div style={{maxWidth:480,margin:'0 auto',padding:'12px 16px',display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <h1 style={{fontSize:20,fontWeight:700,color:'#1c1c1e'}}>Workout Tracker</h1>
              <button onClick={()=>setShowMenu(!showMenu)} style={{padding:8,borderRadius:8,background:showMenu?'#e5e5ea':'none',border:'none'}}>
                <Menu size={22} color="#1c1c1e"/>
              </button>
            </div>
          </div>

          {/* Menu */}
          {showMenu&&(
            <div style={{background:'white',borderBottom:'1px solid #e5e5ea'}}>
              <div style={{maxWidth:480,margin:'0 auto',padding:16,display:'flex',flexDirection:'column',gap:8}}>
                <div style={{background:'#f2f2f7',borderRadius:12,padding:12}}>
                  <p style={{color:'#8e8e93',fontSize:11,fontWeight:600,letterSpacing:'0.05em',textTransform:'uppercase',marginBottom:8}}>Program</p>
                  <select value={activeProgramId} onChange={e=>setActiveProgramId(e.target.value)} style={{width:'100%',background:'white',border:'none',borderRadius:8,padding:'10px 12px',fontSize:14,color:'#1c1c1e'}}>
                    {programs.map(p=><option key={p.id} value={p.id}>{p.name}</option>)}
                  </select>
                  {programLoadError&&<p style={{color:'#ff3b30',fontSize:12,marginTop:6}}>{programLoadError}</p>}
                </div>
                <button onClick={exportData} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:'#f2f2f7',borderRadius:12,border:'none',width:'100%',color:'#1c1c1e',fontSize:14,fontWeight:500}}>
                  <Download size={18} color="#007AFF"/> Export Data
                </button>
                <button onClick={()=>fileInputRef.current?.click()} style={{display:'flex',alignItems:'center',gap:12,padding:'12px 16px',background:'#f2f2f7',borderRadius:12,border:'none',width:'100%',color:'#1c1c1e',fontSize:14,fontWeight:500}}>
                  <Upload size={18} color="#007AFF"/> Import Data
                </button>
                <input ref={fileInputRef} type="file" accept=".json" onChange={importData} className="hidden"/>
              </div>
            </div>
          )}

          {/* Content */}
          <div style={{maxWidth:480,margin:'0 auto',padding:16}}>
            {tab==='today'&&renderToday()}
            {tab==='schedule'&&renderSchedule()}
            {tab==='strength'&&renderStrength()}
            {tab==='trends'&&renderTrends()}
            {tab==='history'&&renderHistory()}
          </div>

          {/* Bottom nav */}
          <nav className="nav-bar" style={{position:'fixed',bottom:0,left:0,right:0,zIndex:50}}>
            <div style={{maxWidth:480,margin:'0 auto',display:'flex',justifyContent:'space-around',padding:'8px 0 12px'}}>
              {[
                {key:'today',label:'Today',icon:<Dumbbell size={22}/>},
                {key:'schedule',label:'Schedule',icon:<Calendar size={22}/>},
                {key:'strength',label:'Strength',icon:<TrendingUp size={22}/>},
                {key:'trends',label:'Trends',icon:<TrendingUp size={22}/>},
                {key:'history',label:'History',icon:<Calendar size={22}/>},
              ].map(({key,label,icon})=>(
                <button key={key} onClick={()=>setTab(key)} style={{display:'flex',flexDirection:'column',alignItems:'center',gap:3,background:'none',border:'none',color:tab===key?'#007AFF':'#8e8e93',minWidth:56}}>
                  {icon}
                  <span style={{fontSize:10,fontWeight:tab===key?600:400}}>{label}</span>
                </button>
              ))}
            </div>
          </nav>
        </div>
      );
    }

    ReactDOM.render(<WorkoutTracker/>, document.getElementById('root'));
  </script>
</body>
</html>
