<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Pro Trainer Elite</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
/* Auth Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);z-index:1000;display:none;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.active{display:flex}
.auth-card{background:var(--bg2);padding:1.5rem;border-radius:var(--radius);width:100%;max-width:360px;box-shadow:0 20px 25px -5px rgba(0,0,0,0.1)}
.auth-card h2{margin-bottom:1rem;font-size:1.2rem;font-weight:800}
.auth-input{width:100%;padding:0.6rem;margin-bottom:0.75rem;border:1px solid var(--border);border-radius:8px;background:var(--bg3);color:var(--text);font-family:inherit}
.auth-btn{width:100%;padding:0.7rem;background:var(--accent);color:#fff;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-bottom:0.5rem}
.auth-switch{text-align:center;font-size:0.75rem;color:var(--text3);cursor:pointer}
.sync-status{font-size:0.65rem;font-weight:700;padding:0.2rem 0.5rem;border-radius:99px;margin-left:auto}
.sync-on{background:var(--accent-bg);color:var(--accent)}
.sync-off{background:var(--bg3);color:var(--text3)}
</style>
</head>
<body>

<div class="modal-overlay" id="authModal">
  <div class="auth-card">
    <h2 id="authTitle">Sign In to Sync</h2>
    <input type="text" id="authEmail" class="auth-input" placeholder="Your Name (e.g. Joey)">
    <input type="password" id="authPassword" class="auth-input" placeholder="PIN (e.g. 1102)" inputmode="numeric">
    <button class="auth-btn" id="authBtn" onclick="handleAuth()">Sign In</button>
    <div class="auth-switch" id="authSwitch" onclick="toggleAuthMode()">New user? Register Name/PIN</div>
    <button class="reset-btn" style="width:100%; margin-top:0.5rem;" onclick="closeAuth()">Cancel</button>
  </div>
</div>

<div class="header">
<div class="header-top">
<div class="logo">
  <div class="logo-mark">PT</div>
  <div class="logo-text">
    <span class="logo-title">Pro Trainer Elite</span>
    <span class="logo-tag">Train Like a Pro</span>
  </div>
</div>
<div class="header-controls">
<button class="timer-btn" style="background:var(--bg3); color:var(--text); padding:0.35rem; border:1px solid var(--border); font-size:1rem; display:flex; align-items:center; justify-content:center; width:36px; height:36px;" onclick="pullFromCloud();" title="Force Cloud Pull">&#9729;</button>
<span id="syncIndicator" class="sync-status sync-off" onclick="openAuth()">Offline</span>
<button class="timer-btn home-only" style="padding:0.35rem 0.6rem;font-size:0.7rem;" onclick="shareWorkout()">Share</button>
</div>
</div>
</div>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#f1f5f9;--bg2:#ffffff;--bg3:#f8fafc;--text:#1e293b;--text2:#475569;--text3:#94a3b8;
  --border:#e2e8f0;--accent:#16a34a;--accent2:#22c55e;--accent-bg:#f0fdf4;
  --red:#ef4444;--blue:#3b82f6;--amber:#f59e0b;--purple:#8b5cf6;
  --radius:12px;--shadow:0 1px 3px rgba(0,0,0,0.08);
}
.dark{
  --bg:#0f172a;--bg2:#1e293b;--bg3:#334155;--text:#f1f5f9;--text2:#cbd5e1;--text3:#64748b;
  --border:#334155;--accent-bg:#064e3b;--shadow:0 1px 3px rgba(0,0,0,0.3);
}
/* Global Mobile Fixes */
body{overflow-x:hidden; width:100%; position:relative;}
.content{padding:0.75rem 0.5rem; width:100%; max-width:100vw; overflow-x:hidden;}
.ex-card{width:100%; margin-left:0; margin-right:0; overflow:hidden;}
.weight-row{flex-wrap:wrap; gap:0.4rem;}
.weight-input{width:60px !important;}
.reps-select{width:60px !important;}
.wlog-table{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch;}
.wlog-table table{min-width:100%; font-size:0.8rem;}
.wlog-table th, .wlog-table td{padding:0.5rem 0.25rem;}
.ex-details{padding-left:0.5rem; padding-right:0.5rem;}
.ex-name-preview{display:block; font-size:0.6rem; opacity:0.7; margin-top:2px;}

/* Header */
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0.75rem 1rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow)}
.header-top{display:flex;justify-content:space-between;align-items:center;max-width:900px;margin:0 auto}
.logo{display:flex;align-items:center;gap:0.6rem}
.logo-mark{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#0f172a,#16a34a);display:flex;align-items:center;justify-content:center;color:#fff;font-size:1rem;font-weight:800;letter-spacing:0.08em}
.logo-text{display:flex;flex-direction:column;line-height:1}
.logo-title{font-size:1rem;font-weight:800;letter-spacing:0.14em;text-transform:uppercase;color:var(--text)}
.logo-tag{font-size:0.65rem;font-weight:700;letter-spacing:0.22em;text-transform:uppercase;color:var(--text3);margin-top:0.2rem}
.header-controls{display:flex;gap:0.5rem;align-items:center}
.week-select{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.35rem 0.5rem;font-size:0.8rem;font-weight:600;color:var(--text);font-family:inherit;cursor:pointer}
.dark-toggle{background:var(--bg3);border:1px solid var(--border);border-radius:8px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:all 0.2s}
.dark-toggle:hover{border-color:var(--accent)}

/* Top Tabs */
.top-tabs{background:var(--bg2);border-bottom:1px solid var(--border)}
.top-tabs-inner{max-width:900px;margin:0 auto;padding:0 0.75rem;display:flex;gap:0.5rem}
.top-tab{padding:0.65rem 0.9rem;font-size:0.8rem;font-weight:700;color:var(--text2);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;font-family:inherit;transition:all 0.2s}
.top-tab:hover{color:var(--text)}
.top-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* Day Tabs */
.tabs-wrap{background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.tabs-wrap::-webkit-scrollbar{display:none}
.tabs{display:flex;max-width:900px;margin:0 auto;padding:0 0.5rem;gap:0.25rem}
.tab{padding:0.6rem 0.75rem;font-size:0.75rem;font-weight:600;color:var(--text3);background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;white-space:nowrap;font-family:inherit;transition:all 0.2s}
.tab:hover{color:var(--text2)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab .tab-check{color:var(--accent2);margin-left:3px;font-size:0.65rem}

/* Progress Bar */
.progress-bar-wrap{background:var(--bg2);padding:0.5rem 1rem;border-bottom:1px solid var(--border)}
.progress-bar-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;gap:0.75rem}
.progress-track{flex:1;height:8px;background:var(--bg3);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:4px;transition:width 0.4s ease}
.progress-text{font-size:0.7rem;font-weight:700;color:var(--accent);white-space:nowrap}

/* Content */
.content{max-width:900px;margin:0 auto;padding:0.75rem}
.day-content{display:none}
.day-content.active{display:block}
.workout-tabs{display:flex;align-items:stretch;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--bg2);margin:0.5rem 0 0.75rem}
.workout-tab{flex:1;padding:0.6rem 0.5rem;font-size:0.75rem;font-weight:700;color:var(--text2);background:var(--bg2);border:none;border-bottom:3px solid transparent;cursor:pointer;font-family:inherit;transition:all 0.2s}
.workout-tab + .workout-tab{border-left:1px solid var(--border)}
.workout-tab:hover{color:var(--text)}
.workout-tab.active{color:var(--accent);border-bottom-color:var(--accent);background:var(--accent-bg)}
.workout-section{display:none}
.workout-section.active{display:block}

/* Home Controls */
.home-controls{display:flex;align-items:center;gap:0.6rem;flex-wrap:wrap;margin-bottom:0.5rem}
.toggle-wrap{display:flex;align-items:center;gap:0.4rem;font-size:0.75rem;color:var(--text2);font-weight:600}
.toggle-wrap input{accent-color:var(--accent)}
.show-completed-btn{background:none;border:none;color:var(--blue);font-size:0.7rem;font-weight:700;cursor:pointer;padding:0.2rem 0.35rem}
.show-completed-btn:hover{text-decoration:underline}

/* Phase Section */
.phase{margin-bottom:1rem}
.phase-header{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;padding:0.5rem 0.75rem;border-radius:var(--radius) var(--radius) 0 0;display:flex;align-items:center;gap:0.4rem;justify-content:space-between;cursor:pointer}
.phase-header .phase-title{display:flex;align-items:center;gap:0.4rem}
.phase-toggle{display:inline-flex;align-items:center;gap:0.25rem;font-size:0.65rem;font-weight:700}
.phase-toggle .arrow{transition:transform 0.2s}
.phase.collapsed .phase-toggle .arrow{transform:rotate(-90deg)}
.phase-body{border-radius:0 0 var(--radius) var(--radius)}
.phase.collapsed .phase-body{display:none}
.phase-header.stretch{background:#eff6ff;color:#1d4ed8}.dark .phase-header.stretch{background:#1e3a5f;color:#93c5fd}
.phase-header.main{background:var(--accent-bg);color:#166534}.dark .phase-header.main{background:#064e3b;color:#86efac}
.phase-header.bonus{background:#fef3c7;color:#92400e}.dark .phase-header.bonus{background:#451a03;color:#fcd34d}

/* Exercise Cards */
.ex-card{background:var(--bg2);border:1px solid var(--border);border-top:none;padding:0.75rem;display:flex;gap:0.6rem;align-items:flex-start;transition:background 0.2s, transform 0.3s ease;position:relative;overflow:hidden;touch-action:pan-y}
.ex-card.swiping{transition:none}
.ex-card.swapped-ui{border-left:4px solid var(--amber)}
.ex-swap-indicator{font-size:0.6rem;font-weight:800;color:var(--amber);text-transform:uppercase;margin-bottom:0.1rem;display:flex;align-items:center;gap:0.2rem}
.ex-card:last-child{border-radius:0 0 var(--radius) var(--radius)}
.ex-card.done{background:var(--accent-bg);opacity:0.75}
.ex-card.completed{opacity:0.6}
.ex-card.completed .ex-name{text-decoration:line-through}
.ex-card.collapsed .ex-details{display:none}
.ex-header{display:flex;align-items:center;justify-content:space-between;gap:0.5rem}
.ex-toggle{border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:0.65rem;font-weight:700;border-radius:999px;padding:0.15rem 0.5rem;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:0.25rem}
.ex-toggle:hover{border-color:var(--accent)}
.ex-toggle .arrow{display:inline-block;transition:transform 0.2s}
.ex-toggle.open .arrow{transform:rotate(90deg)}
.ex-link{color:var(--text);text-decoration:none}
.ex-link:hover{text-decoration:underline}
.ex-link-btn{background:none;border:none;padding:0;text-align:left;cursor:pointer;font:inherit;color:var(--text)}
.ex-link-btn:hover{text-decoration:underline}
.ex-check{width:24px;height:24px;border:2px solid var(--border);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s;margin-top:2px;font-size:0.8rem;color:transparent}
.ex-check.checked{background:var(--accent);border-color:var(--accent);color:#fff}
.ex-body{flex:1;min-width:0}
.ex-name{font-size:0.85rem;font-weight:700;color:var(--text);margin-bottom:0.3rem}
.ex-name-row{display:flex;align-items:center;justify-content:space-between;gap:0.5rem}
.ex-name-preview{font-size:0.7rem;color:var(--text3);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ex-meta{display:flex;flex-wrap:wrap;gap:0.35rem;margin-bottom:0.35rem}
.ex-tag{font-size:0.65rem;font-weight:600;padding:0.15rem 0.45rem;border-radius:4px;background:var(--bg3);color:var(--text2)}
.ex-tag.sets{background:#dbeafe;color:#1e40af}.dark .ex-tag.sets{background:#1e3a5f;color:#93c5fd}
.ex-tag.rest{background:#fce7f3;color:#9d174d}.dark .ex-tag.rest{background:#4a0e2e;color:#f9a8d4}
.ex-tag.tempo{background:#f3e8ff;color:#6b21a8}.dark .ex-tag.tempo{background:#3b0764;color:#c4b5fd}
.ex-notes{font-size:0.72rem;color:var(--text3);line-height:1.4;margin-bottom:0.3rem}
.ex-equip{font-size:0.65rem;color:var(--text3);font-style:italic}
.ex-complete{margin-top:0.4rem;display:flex;align-items:center;gap:0.4rem;font-size:0.7rem;color:var(--text2);font-weight:600}
.ex-complete input{accent-color:var(--accent)}
.weight-row{display:flex;gap:0.4rem;align-items:center;margin-top:0.35rem;flex-wrap:wrap}
.weight-input{width:65px;padding:0.25rem 0.4rem;border:1px solid var(--border);border-radius:6px;font-size:0.78rem;font-family:inherit;background:var(--bg3);color:var(--text);text-align:center}
.weight-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(22,163,74,0.15)}
.weight-label{font-size:0.68rem;color:var(--text3)}
.reps-select{padding:0.25rem 0.4rem;border:1px solid var(--border);border-radius:6px;font-size:0.78rem;font-family:inherit;background:var(--bg3);color:var(--text);text-align:center}

/* Rest Timer */
.timer-bar{position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);padding:0.6rem 1rem;z-index:99;box-shadow:0 -2px 8px rgba(0,0,0,0.1);transform:translateY(100%);transition:transform 0.3s}
.timer-bar.visible{transform:translateY(0)}
.timer-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;gap:0.75rem}
.timer-display{font-size:1.5rem;font-weight:800;color:var(--accent);font-variant-numeric:tabular-nums;min-width:60px}
.timer-btns{display:flex;gap:0.35rem}
.timer-btn{padding:0.4rem 0.8rem;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:0.75rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
.timer-btn:hover{border-color:var(--accent)}
.timer-btn.go{background:var(--accent);color:#fff;border-color:var(--accent)}
.timer-presets{display:flex;gap:0.25rem;margin-left:auto}
.timer-preset{padding:0.3rem 0.5rem;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:0.65rem;font-weight:600;cursor:pointer;font-family:inherit}
.timer-preset:hover{border-color:var(--accent)}
.timer-toggle{position:fixed;bottom:1rem;right:1rem;width:50px;height:50px;border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:1.3rem;cursor:pointer;box-shadow:0 4px 12px rgba(22,163,74,0.3);z-index:98;display:flex;align-items:center;justify-content:center}

/* Sunday */
.sunday-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem}
.sunday-card h3{font-size:0.85rem;font-weight:700;margin-bottom:0.3rem;display:flex;align-items:center;gap:0.4rem}
.sunday-card p{font-size:0.8rem;color:var(--text2);line-height:1.5}
.sunday-card .dur{font-size:0.7rem;color:var(--text3);margin-top:0.2rem}

/* Guide */
.guide-content{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1.25rem;font-size:0.82rem;color:var(--text2);line-height:1.7}
.guide-content h2{font-size:1rem;font-weight:800;color:var(--text);margin:1.25rem 0 0.5rem;padding-bottom:0.3rem;border-bottom:2px solid var(--accent)}
.guide-content h2:first-child{margin-top:0}
.guide-content h3{font-size:0.88rem;font-weight:700;color:var(--text);margin:0.75rem 0 0.35rem}
.guide-content ul,
.guide-content ol{margin:0.35rem 0 0.5rem 1.25rem}
.guide-content li{margin-bottom:0.2rem}
.guide-content strong{color:var(--text)}
.guide-content p{margin-bottom:0.5rem}

/* Reset Dialog */
.reset-btn{font-size:0.7rem;color:var(--red);background:none;border:none;cursor:pointer;font-weight:600;padding:0.35rem;font-family:inherit}
.reset-btn:hover{text-decoration:underline}

/* Program Panel */
.program-only,.history-only{display:none}
.tab-program .home-only,.tab-history .home-only{display:none!important}
.tab-program .program-only{display:block!important}
.tab-history .history-only{display:block!important}
.program-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem}
.program-card h2{font-size:1rem;font-weight:800;margin-bottom:0.6rem;color:var(--text)}
.program-row{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap;margin-bottom:0.6rem}
.program-select{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0.45rem 0.6rem;font-size:0.8rem;font-weight:600;color:var(--text);font-family:inherit;cursor:pointer}
.program-btn{padding:0.4rem 0.8rem;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:0.75rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.2s}
.program-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.program-btn:hover{border-color:var(--accent)}
.program-meta{font-size:0.78rem;color:var(--text2);line-height:1.5}

/* Today's Weight */
.weight-panel{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem;margin-bottom:0.75rem}
.weight-header{display:flex;align-items:center;justify-content:space-between;gap:0.5rem;font-size:0.75rem;font-weight:800;text-transform:uppercase;letter-spacing:0.12em;color:var(--text)}
.weight-toggle{border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:0.65rem;font-weight:700;border-radius:999px;padding:0.15rem 0.55rem;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:0.25rem}
.weight-toggle .arrow{transition:transform 0.2s}
.weight-panel.collapsed .weight-toggle .arrow{transform:rotate(-90deg)}
.weight-body{margin-top:0.6rem}
.weight-panel.collapsed .weight-body{display:none}
.weight-row-inline{display:flex;align-items:center;gap:0.5rem;flex-wrap:wrap}
.weight-input-lg{width:90px;padding:0.4rem 0.5rem;border:1px solid var(--border);border-radius:8px;font-size:0.85rem;font-family:inherit;background:var(--bg3);color:var(--text);text-align:center}
.weight-input-lg:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(22,163,74,0.15)}
.weight-btn{padding:0.4rem 0.75rem;border-radius:8px;border:none;background:var(--accent);color:#fff;font-size:0.75rem;font-weight:700;cursor:pointer;font-family:inherit;transition:background 0.2s}
.weight-btn:hover{background:var(--accent2)}
.weight-last{font-size:0.7rem;color:var(--text3)}

/* Week Status */
.week-select.status-today{background:#ffffff;color:#0f172a;border-color:#e2e8f0}
.week-select.status-good{background:#16a34a;color:#fff;border-color:#16a34a}
.week-select.status-mid{background:#f59e0b;color:#1e293b;border-color:#f59e0b}
.week-select.status-none{background:#ef4444;color:#fff;border-color:#ef4444}
.week-select.status-future{background:#e2e8f0;color:#475569;border-color:#e2e8f0}
.dark .week-select.status-today{background:#f8fafc;color:#0f172a}
.dark .week-select.status-mid{color:#0f172a}
.dark .week-select.status-future{background:#475569;color:#f1f5f9;border-color:#475569}

/* Weight Log Tab */
.wlog-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.5rem}
.wlog-header h2{font-size:1.1rem;font-weight:800;color:var(--text)}
.wlog-range-btns{display:flex;gap:0.25rem}
.wlog-range-btn{padding:0.35rem 0.65rem;border-radius:6px;border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:0.7rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
.wlog-range-btn:hover{border-color:var(--accent)}
.wlog-range-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.wlog-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.5rem;margin-bottom:1rem}
.wlog-stat{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem;text-align:center}
.wlog-stat .val{font-size:1.2rem;font-weight:800;color:var(--accent)}
.wlog-stat .lbl{font-size:0.65rem;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.05em;margin-top:0.15rem}
.wlog-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:1rem;min-height:180px;position:relative}
.wlog-chart canvas{width:100%!important;height:160px!important}
.wlog-table{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.wlog-table table{width:100%;border-collapse:collapse;font-size:0.8rem}
.wlog-table th{background:var(--bg3);padding:0.5rem 0.75rem;text-align:left;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text3);border-bottom:1px solid var(--border)}
.wlog-table td{padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);color:var(--text2)}
.wlog-table tr:last-child td{border-bottom:none}
.wlog-table .change-up{color:var(--red);font-weight:600}
.wlog-table .change-down{color:var(--accent);font-weight:600}
.wlog-table .change-same{color:var(--text3)}
.wlog-empty{text-align:center;padding:2rem;color:var(--text3);font-size:0.85rem}
.wlog-delete{background:none;border:none;color:var(--text3);cursor:pointer;font-size:0.75rem;padding:0.2rem;opacity:0.5;transition:opacity 0.2s}
.wlog-delete:hover{opacity:1;color:var(--red)}

/* Exercise Info Dropdown */
.ex-info-toggle{font-size:0.68rem;font-weight:600;color:var(--blue);cursor:pointer;display:inline-flex;align-items:center;gap:0.25rem;margin-top:0.3rem;user-select:none;transition:color 0.2s}
.ex-info-toggle:hover{color:#2563eb}
.ex-info-toggle .arrow{display:inline-block;font-size:0.5rem;transition:transform 0.2s}
.ex-info-toggle.open .arrow{transform:rotate(90deg)}
.ex-info-box{max-height:0;overflow:hidden;transition:max-height 0.3s ease,opacity 0.3s ease;opacity:0}
.ex-info-box.open{max-height:300px;opacity:1}
.ex-info-content{margin-top:0.4rem;padding:0.6rem 0.75rem;background:var(--bg3);border-radius:8px;border-left:3px solid var(--blue);font-size:0.75rem;color:var(--text2);line-height:1.6}
.ex-info-content strong{color:var(--text);font-weight:700}
.ex-visual{margin-top:0.5rem;border:1px solid var(--accent);border-radius:8px;background:var(--accent-bg)}
.ex-visual summary{cursor:pointer;padding:0.4rem 0.6rem;font-weight:700;color:var(--accent);list-style:none}
.ex-visual summary::-webkit-details-marker{display:none}
.ex-visual[open] summary{border-bottom:1px solid var(--accent)}
.ex-visual-body{padding:0.5rem 0.6rem}
.ex-visual-body img{max-width:100%;border:1px solid var(--border);border-radius:8px;display:block;background:var(--bg2)}

/* Detail View */
.detail-view{position:fixed;inset:0;background:var(--bg);z-index:200;display:none;overflow-y:auto}
.detail-view.active{display:block}
.detail-inner{max-width:900px;margin:0 auto;padding:1rem}
.detail-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem}
.detail-back{padding:0.4rem 0.75rem;border-radius:8px;border:1px solid var(--accent);background:var(--accent-bg);color:var(--accent);font-size:0.75rem;font-weight:800;cursor:pointer;font-family:inherit}
.detail-back:hover{border-color:var(--accent2);color:var(--accent2)}
.detail-title{font-size:1.2rem;font-weight:800;color:var(--text)}
.detail-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:0.9rem;margin-bottom:0.75rem}
.detail-card h3{font-size:0.85rem;font-weight:800;margin-bottom:0.45rem;color:var(--accent)}
.detail-diagram img{max-width:100%;border:1px solid var(--border);border-radius:8px;display:block;background:var(--bg2)}
.detail-history{display:grid;gap:0.5rem}
.detail-history-item{display:flex;justify-content:space-between;gap:0.5rem;font-size:0.78rem;color:var(--text2);padding:0.45rem 0.6rem;border:1px solid var(--border);border-radius:8px;background:var(--bg3)}
.detail-history-item span{white-space:nowrap}
.detail-history-empty{font-size:0.78rem;color:var(--text3)}

/* Mobile */
@media(max-width:640px){
.tab{padding:0.5rem 0.6rem;font-size:0.7rem}
.ex-card{padding:0.6rem}
.timer-presets{display:none}
}
@media(min-width:641px){
.timer-toggle{display:none}
.timer-bar{transform:translateY(0) !important}
.timer-bar.visible{transform:translateY(0)}
}
</style>
</head>
<body>

<div class="header">
<div class="header-top">
<div class="logo">
  <div class="logo-mark">PT</div>
  <div class="logo-text">
    <span class="logo-title">Pro Trainer Elite</span>
    <span class="logo-tag">Train Like a Pro</span>
  </div>
</div>
<div class="header-controls">
<button class="timer-btn home-only" style="padding:0.35rem 0.6rem;font-size:0.7rem;" onclick="shareWorkout()">Share</button>
<select class="week-select home-only" id="weekSelect" onchange="setWeek(this.value)">
<option value="1">Week 1</option><option value="2">Week 2</option><option value="3">Week 3</option>
<option value="4">Week 4</option><option value="5">Week 5</option><option value="6">Week 6 (Deload)</option>
</select>
<button class="dark-toggle" id="darkToggle" onclick="toggleDark()">&#9790;</button>
<button class="reset-btn home-only" onclick="if(confirm('Reset ALL progress for this week?')){resetWeek()}">Reset</button>
</div>
</div>
</div>

<div class="top-tabs">
<div class="top-tabs-inner">
<button class="top-tab" id="homeTabBtn" onclick="setActiveTab('home')">Home</button>
<button class="top-tab" id="programTabBtn" onclick="setActiveTab('program')">Program</button>
<button class="top-tab" id="historyTabBtn" onclick="setActiveTab('history')">History</button>
</div>
</div>

<div class="tabs-wrap home-only" id="dayTabsWrap">
<div class="tabs" id="tabs"></div>
</div>

<div class="progress-bar-wrap home-only" id="progressWrap">
<div class="progress-bar-inner">
<div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
<span class="progress-text" id="progressText">0/0</span>
</div>
</div>

<div class="content home-only" id="content"></div>
<div class="content program-only" id="programArea"></div>
<div class="content history-only" id="historyArea"></div>

<div class="detail-view" id="detailView" aria-hidden="true">
  <div class="detail-inner" id="detailContent"></div>
</div>

<button class="timer-toggle home-only" id="timerToggle" onclick="showTimer()">&#9201;</button>
<div class="timer-bar home-only" id="timerBar">
<div class="timer-inner">
<div class="timer-display" id="timerDisplay">0:00</div>
<div class="timer-btns">
<button class="timer-btn go" id="timerStartBtn" onclick="timerStart()">Start</button>
<button class="timer-btn" onclick="timerReset()">Reset</button>
</div>
<div class="timer-presets">
<button class="timer-preset" onclick="timerSet(30)">30s</button>
<button class="timer-preset" onclick="timerSet(45)">45s</button>
<button class="timer-preset" onclick="timerSet(60)">60s</button>
<button class="timer-preset" onclick="timerSet(90)">90s</button>
<button class="timer-preset" onclick="timerSet(120)">2m</button>
</div>
</div>
</div>

<script>
// ============ WORKOUT DATA ============
const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday','Weight Log'];
const WORKOUTS = {
Monday: [
{phase:'Pre-Workout Stretch',exercise:'World\'s Greatest Stretch',sets:'2',reps:'5 each side',rest:0,tempo:'Slow',notes:'Hip flexor + thoracic rotation opener, hold each position 3 sec',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Arm Circles (Forward/Backward)',sets:'2',reps:'10 each direction',rest:0,tempo:'Controlled',notes:'Shoulder warmup for pressing movements',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Cat-Cow Spine Waves',sets:'2',reps:'10 reps',rest:0,tempo:'Smooth',notes:'Spinal mobility and core activation',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Scapular Wall Slides',sets:'2',reps:'12 reps',rest:0,tempo:'Controlled',notes:'Shoulder blade activation before pressing',equipment:'Wall'},
{phase:'Pre-Workout Stretch',exercise:'Standing Torso Rotations',sets:'2',reps:'10 each side',rest:0,tempo:'Smooth',notes:'Golf-specific rotational warmup',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Incline Chest Press Machine',sets:'4',reps:'8-10',rest:90,tempo:'3010',notes:'Primary push - safer for shoulders than flat. SUB: Incline DB Press',equipment:'Machine'},
{phase:'Main Workout',exercise:'Standing Cable Chest Fly',sets:'3',reps:'12-15',rest:60,tempo:'2020',notes:'Horizontal adduction for pec development. SUB: Pec Deck Machine',equipment:'Cable'},
{phase:'Main Workout',exercise:'Seated Overhead Press Machine',sets:'4',reps:'8-10',rest:90,tempo:'3010',notes:'Vertical push for shoulders. SUB: DB Shoulder Press seated',equipment:'Machine'},
{phase:'Main Workout',exercise:'Cable Lateral Raise',sets:'3',reps:'12-15',rest:60,tempo:'2011',notes:'Medial deltoid isolation. SUB: DB Lateral Raise',equipment:'Cable'},
{phase:'Main Workout',exercise:'Tricep Rope Pushdown',sets:'3',reps:'12-15',rest:60,tempo:'2011',notes:'Elbow extension. SUB: Overhead Cable Tricep Extension',equipment:'Cable'},
{phase:'Main Workout',exercise:'Cable Pallof Press',sets:'3',reps:'10 each side',rest:45,tempo:'2120',notes:'Anti-rotation core - hold cable at chest, press out. SUB: Band Pallof Press',equipment:'Cable'},
{phase:'Main Workout',exercise:'Cable Woodchop High-to-Low',sets:'3',reps:'12 each side',rest:45,tempo:'2010',notes:'Rotational power for golf swing. SUB: Medicine Ball Slam diagonal',equipment:'Cable'},
{phase:'Main Workout',exercise:'Decline Sit-Up or Weighted Crunch',sets:'4',reps:'15-20',rest:45,tempo:'2011',notes:'Direct ab work for visible definition. SUB: Cable Crunch kneeling',equipment:'Bench/Machine'},
{phase:'Main Workout',exercise:'Plank with Shoulder Taps',sets:'3',reps:'20 total taps',rest:45,tempo:'Controlled',notes:'Anti-rotation and core stability. SUB: High Plank Hold',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Face Pulls',sets:'3',reps:'15-20',rest:45,tempo:'2021',notes:'Rear delt and upper back health. SUB: Reverse Pec Deck',equipment:'Cable'},
{phase:'Bonus (Optional)',exercise:'Incline DB Chest Fly',sets:'2',reps:'12-15',rest:60,tempo:'3020',notes:'Additional chest volume with stretch emphasis. SUB: Pec Deck Machine',equipment:'Dumbbells'},
{phase:'Bonus (Optional)',exercise:'Hanging Knee Raises',sets:'3',reps:'12-15',rest:60,tempo:'2011',notes:'Lower ab focus. SUB: Lying Leg Raises if no pull-up bar',equipment:'Pull-up Bar'},
{phase:'Bonus (Optional)',exercise:'Dead Bug',sets:'2',reps:'10 each side',rest:30,tempo:'Slow',notes:'Core stability and coordination. SUB: Bird Dog',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Chest and Shoulder Static Stretch',sets:'1',reps:'60 sec each',rest:0,tempo:'Hold',notes:'Doorway pec stretch, cross-body shoulder stretch, tricep stretch. SUB: Wall Pec Stretch',equipment:'Doorway/Wall'}
],
Tuesday: [
{phase:'Pre-Workout Stretch',exercise:'90/90 Hip Stretch',sets:'2',reps:'30 sec each side',rest:0,tempo:'Hold',notes:'Internal and external hip rotation mobility. SUB: Pigeon Pose',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Standing Quad Stretch with Reach',sets:'2',reps:'30 sec each side',rest:0,tempo:'Hold',notes:'Hip flexor and quad opener - reach overhead. SUB: Lying Quad Stretch',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Cossack Squat',sets:'2',reps:'8 each side',rest:0,tempo:'Controlled',notes:'Lateral hip mobility and adductor stretch. SUB: Lateral Lunge',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Glute Bridge Pulses',sets:'2',reps:'15 reps',rest:0,tempo:'Controlled',notes:'Glute activation before loading. SUB: Banded Clamshells',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Ankle Circles + Calf Raises',sets:'2',reps:'10 each',rest:0,tempo:'Smooth',notes:'Lower leg prep for squat/lunge patterns. SUB: Ankle Alphabet',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Leg Press (Feet Mid-Platform)',sets:'4',reps:'10-12',rest:90,tempo:'3010',notes:'Primary leg builder - keep knees tracking over toes. SUB: Smith Machine Squat',equipment:'Machine'},
{phase:'Main Workout',exercise:'Romanian Deadlift (Smith Machine or DB)',sets:'4',reps:'10-12',rest:90,tempo:'3110',notes:'Hamstring and glute focus - hinge pattern. SUB: Lying Leg Curl Machine',equipment:'Smith/DB'},
{phase:'Main Workout',exercise:'Bulgarian Split Squat (DB)',sets:'3',reps:'10 each leg',rest:60,tempo:'3010',notes:'Unilateral strength and balance - rear foot elevated. SUB: Walking Lunges',equipment:'Dumbbells'},
{phase:'Main Workout',exercise:'Leg Extension Machine',sets:'3',reps:'12-15',rest:60,tempo:'2012',notes:'Quad isolation - avoid locking out fully for knee safety. SUB: Goblet Squat',equipment:'Machine'},
{phase:'Main Workout',exercise:'Seated or Lying Leg Curl',sets:'3',reps:'12-15',rest:60,tempo:'2012',notes:'Hamstring isolation. SUB: Stability Ball Hamstring Curl',equipment:'Machine'},
{phase:'Main Workout',exercise:'Cable Hip Abduction',sets:'3',reps:'15 each leg',rest:45,tempo:'2011',notes:'Glute medius for hip stability. SUB: Lateral Band Walks',equipment:'Cable/Band'},
{phase:'Main Workout',exercise:'Single-Leg Glute Bridge',sets:'3',reps:'12 each leg',rest:45,tempo:'2021',notes:'Glute isolation and hip stability - squeeze at top. SUB: Standard Glute Bridge',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Standing Calf Raises (Smith Machine)',sets:'4',reps:'15-20',rest:60,tempo:'2012',notes:'Calf development and ankle stability. SUB: Seated Calf Raise Machine',equipment:'Smith/Machine'},
{phase:'Main Workout',exercise:'Copenhagen Plank (or Side Plank)',sets:'3',reps:'20-30 sec each',rest:45,tempo:'Hold',notes:'Adductor and lateral core strength. SUB: Standard side plank',equipment:'Bench'},
{phase:'Bonus (Optional)',exercise:'Goblet Squat Hold',sets:'3',reps:'30-45 sec',rest:60,tempo:'Hold',notes:'Hip and ankle mobility with load. SUB: Wall Sit',equipment:'Dumbbell'},
{phase:'Bonus (Optional)',exercise:'Step-Ups (DB)',sets:'3',reps:'12 each leg',rest:60,tempo:'Controlled',notes:'Single leg power. SUB: Box Squats',equipment:'Bench/DB'},
{phase:'Bonus (Optional)',exercise:'Seated Hip Flexor Stretch',sets:'1',reps:'60 sec each',rest:0,tempo:'Hold',notes:'Release hip flexor tightness from sitting. SUB: Standing Hip Flexor Stretch',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Pigeon Pose',sets:'1',reps:'60 sec each',rest:0,tempo:'Hold',notes:'Deep hip opener for external rotation. SUB: Figure-4 Stretch',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Standing Hamstring Stretch',sets:'1',reps:'45 sec each',rest:0,tempo:'Hold',notes:'Post-workout hamstring mobility. SUB: Lying Hamstring Stretch',equipment:'Bodyweight'}
],
Wednesday: [
{phase:'Pre-Workout Stretch',exercise:'Thread the Needle (Thoracic Rotation)',sets:'2',reps:'8 each side',rest:0,tempo:'Smooth',notes:'Upper back and shoulder mobility. SUB: Cat-Cow',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Band Pull-Aparts',sets:'2',reps:'15 reps',rest:0,tempo:'Controlled',notes:'Scapular retraction and rear delt warmup. SUB: Scapular Wall Slides',equipment:'Resistance Band'},
{phase:'Pre-Workout Stretch',exercise:'Scapular Shrugs (Hanging or Supported)',sets:'2',reps:'10 reps',rest:0,tempo:'Controlled',notes:'Lat and scapular activation. SUB: Scapular Push-ups',equipment:'Pull-up Bar'},
{phase:'Pre-Workout Stretch',exercise:'Doorway Chest Stretch',sets:'2',reps:'30 sec each side',rest:0,tempo:'Hold',notes:'Open chest before pulling movements. SUB: Wall Chest Stretch',equipment:'Doorway'},
{phase:'Pre-Workout Stretch',exercise:'Wrist Circles + Forearm Stretch',sets:'2',reps:'10 each direction',rest:0,tempo:'Smooth',notes:'Grip prep for rowing and pulling. SUB: Wrist Extensions',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Lat Pulldown (Wide Grip)',sets:'4',reps:'8-10',rest:90,tempo:'3011',notes:'Primary vertical pull. SUB: Assisted Pull-Up Machine',equipment:'Machine'},
{phase:'Main Workout',exercise:'Seated Cable Row (Neutral Grip)',sets:'4',reps:'10-12',rest:90,tempo:'3011',notes:'Horizontal pull for mid-back. SUB: Chest-Supported Row Machine',equipment:'Cable/Machine'},
{phase:'Main Workout',exercise:'Single-Arm Dumbbell Row',sets:'3',reps:'10-12 each',rest:60,tempo:'3011',notes:'Unilateral back strength. SUB: Single-Arm Cable Row',equipment:'Dumbbells'},
{phase:'Main Workout',exercise:'Face Pulls (Rope Attachment)',sets:'3',reps:'15-20',rest:60,tempo:'2021',notes:'Rear delt and upper back health. SUB: Reverse Fly Machine',equipment:'Cable'},
{phase:'Main Workout',exercise:'EZ-Bar or Cable Bicep Curl',sets:'3',reps:'10-12',rest:60,tempo:'3010',notes:'Bicep development. SUB: Dumbbell Hammer Curl',equipment:'Cable/Barbell'},
{phase:'Main Workout',exercise:'Cable Hammer Curl (Rope)',sets:'3',reps:'12-15',rest:60,tempo:'2010',notes:'Brachialis and forearm focus. SUB: DB Hammer Curl',equipment:'Cable'},
{phase:'Main Workout',exercise:'Pallof Press (Isometric Hold)',sets:'3',reps:'20-30 sec each',rest:45,tempo:'Hold',notes:'Anti-rotation core endurance. SUB: Band Pallof Hold',equipment:'Cable'},
{phase:'Main Workout',exercise:'Bird Dog',sets:'3',reps:'10 each side',rest:45,tempo:'3111',notes:'Core stability and spinal control. SUB: Dead Bug',equipment:'Mat'},
{phase:'Main Workout',exercise:'Russian Twist (Weighted)',sets:'4',reps:'20 total reps',rest:45,tempo:'Controlled',notes:'Rotational ab work. SUB: Standing Cable Twist',equipment:'Medicine Ball/DB'},
{phase:'Bonus (Optional)',exercise:'Straight-Arm Lat Pulldown',sets:'3',reps:'15',rest:60,tempo:'2021',notes:'Lat isolation and shoulder stability. SUB: Dumbbell Pullover',equipment:'Cable'},
{phase:'Bonus (Optional)',exercise:'Farmer\'s Carry',sets:'3',reps:'40-60 sec',rest:90,tempo:'Walk',notes:'Grip strength and core stability. SUB: Static Hold with heavy DBs',equipment:'Dumbbells'},
{phase:'Bonus (Optional)',exercise:'Cable Woodchop Low-to-High',sets:'3',reps:'12 each side',rest:45,tempo:'2010',notes:'Golf-specific rotation. SUB: Medicine Ball Rotational Throw',equipment:'Cable'},
{phase:'Bonus (Optional)',exercise:'Hanging L-Sit Hold',sets:'3',reps:'15-30 sec',rest:60,tempo:'Hold',notes:'Advanced core and hip flexor strength. SUB: Hanging Knee Hold',equipment:'Pull-up Bar'},
{phase:'Bonus (Optional)',exercise:'Upper Back and Lat Stretch',sets:'1',reps:'60 sec each',rest:0,tempo:'Hold',notes:'Child\'s pose, lat stretch on post, doorway stretch. SUB: Wall Lat Stretch',equipment:'Mat/Doorway'}
],
Thursday: [
{phase:'Pre-Workout Stretch',exercise:'Inchworm to Push-Up',sets:'2',reps:'6 reps',rest:0,tempo:'Controlled',notes:'Full body dynamic warmup. SUB: Standard Push-up',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Spiderman Lunge with Rotation',sets:'2',reps:'6 each side',rest:0,tempo:'Smooth',notes:'Hip flexor, thoracic spine, and hamstring opener. SUB: World\'s Greatest Stretch',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Hip Hinge Practice (Unweighted)',sets:'2',reps:'10 reps',rest:0,tempo:'Controlled',notes:'Reinforce proper hinge pattern before loading. SUB: Good Morning (unweighted)',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Arm Swings (Across Body)',sets:'2',reps:'10 each',rest:0,tempo:'Dynamic',notes:'Shoulder mobility and blood flow. SUB: Arm Circles',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Leg Swings (Forward/Lateral)',sets:'2',reps:'10 each leg',rest:0,tempo:'Dynamic',notes:'Hip mobility prep for full body work. SUB: Hip Circles',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Trap Bar Deadlift or Smith Machine Deadlift',sets:'4',reps:'6-8',rest:120,tempo:'3110',notes:'Primary power movement - knee-safe hinge. SUB: Sumo Deadlift on Smith',equipment:'Smith/Trap Bar'},
{phase:'Main Workout',exercise:'Goblet Squat (Slow Eccentric)',sets:'3',reps:'10-12',rest:90,tempo:'5010',notes:'Mobility-focused squat with load. SUB: Front Squat on Smith Machine',equipment:'Dumbbell'},
{phase:'Main Workout',exercise:'Single-Leg Romanian Deadlift (DB)',sets:'3',reps:'8 each leg',rest:60,tempo:'3110',notes:'Balance and posterior chain. SUB: Single-Leg Leg Press',equipment:'Dumbbells'},
{phase:'Main Workout',exercise:'Landmine Press (or DB Arnold Press)',sets:'3',reps:'10 each arm',rest:60,tempo:'3010',notes:'Rotational shoulder strength. SUB: Single-Arm DB Overhead Press',equipment:'Landmine/DB'},
{phase:'Main Workout',exercise:'Cable Row to Rotation',sets:'3',reps:'10 each side',rest:60,tempo:'2011',notes:'Pull + rotate for golf-specific power. SUB: DB Row with Rotation',equipment:'Cable'},
{phase:'Main Workout',exercise:'Medicine Ball Rotational Slam',sets:'3',reps:'8 each side',rest:60,tempo:'Explosive',notes:'Power development - slam from golf backswing position. SUB: Cable Woodchop',equipment:'Medicine Ball'},
{phase:'Main Workout',exercise:'TRX or Suspension Row',sets:'3',reps:'12-15',rest:60,tempo:'2011',notes:'Bodyweight pull with core engagement. SUB: Inverted Row on Smith Machine',equipment:'TRX/Smith'},
{phase:'Main Workout',exercise:'Ab Wheel Rollout (or Stability Ball)',sets:'3',reps:'10-12',rest:60,tempo:'3010',notes:'Anti-extension core strength. SUB: Plank Walk-Outs',equipment:'Ab Wheel/Ball'},
{phase:'Main Workout',exercise:'Side Plank with Rotation',sets:'3',reps:'8 each side',rest:45,tempo:'Controlled',notes:'Rotational core control and oblique strength. SUB: Standard Side Plank',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Yoga Flow Sequence',sets:'2',reps:'5 min',rest:0,tempo:'Flowing',notes:'Down dog > Low lunge > Warrior 2 > Triangle > Repeat other side. SUB: Child\'s Pose Flow',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Deep Squat Hold (Goblet)',sets:'2',reps:'60-90 sec',rest:60,tempo:'Hold',notes:'Hip and ankle mobility under light load. SUB: Unweighted Squat Hold',equipment:'Dumbbell'},
{phase:'Bonus (Optional)',exercise:'Thoracic Extension (Foam Roller)',sets:'1',reps:'10 reps',rest:0,tempo:'Controlled',notes:'Upper back mobility for golf posture. SUB: Bench Thoracic Extension',equipment:'Foam Roller'},
{phase:'Bonus (Optional)',exercise:'Hip 90/90 Stretch (Loaded)',sets:'1',reps:'60 sec each',rest:0,tempo:'Hold',notes:'Deep hip mobility with light DB for pressure. SUB: Unloaded 90/90 Stretch',equipment:'Dumbbell/Mat'},
{phase:'Bonus (Optional)',exercise:'Standing Figure-4 Stretch',sets:'1',reps:'45 sec each',rest:0,tempo:'Hold',notes:'Glute and hip external rotator stretch. SUB: Seated Figure-4',equipment:'Bodyweight'}
],
Friday: [
{phase:'Pre-Workout Stretch',exercise:'Cat-Cow to Child\'s Pose Flow',sets:'2',reps:'8 reps',rest:0,tempo:'Flowing',notes:'Spinal mobility and breathing preparation. SUB: Cat-Cow',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Thoracic Rotation (Quadruped)',sets:'2',reps:'10 each side',rest:0,tempo:'Smooth',notes:'Rotational mobility for golf swing. SUB: Thread the Needle',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Hip Circles (Standing)',sets:'2',reps:'10 each direction per leg',rest:0,tempo:'Controlled',notes:'Hip joint mobility and balance. SUB: Leg Swings',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Arm Circles with Torso Lean',sets:'2',reps:'8 each direction',rest:0,tempo:'Dynamic',notes:'Shoulder and oblique warmup. SUB: Arm Swings',equipment:'Bodyweight'},
{phase:'Pre-Workout Stretch',exercise:'Marching High Knees',sets:'2',reps:'20 total',rest:0,tempo:'Controlled',notes:'Core activation and hip flexor warmup. SUB: Glute Bridge Pulses',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Cable Pallof Press (Anti-Rotation)',sets:'4',reps:'12 each side',rest:60,tempo:'2120',notes:'Core stability - resist rotation. SUB: Band Pallof Press',equipment:'Cable'},
{phase:'Main Workout',exercise:'Cable Woodchop High-to-Low',sets:'4',reps:'10 each side',rest:60,tempo:'2010',notes:'Golf downswing pattern. SUB: Medicine Ball Slam diagonal',equipment:'Cable'},
{phase:'Main Workout',exercise:'Cable Woodchop Low-to-High',sets:'4',reps:'10 each side',rest:60,tempo:'2010',notes:'Golf backswing pattern. SUB: Medicine Ball Overhead Throw',equipment:'Cable'},
{phase:'Main Workout',exercise:'Bicycle Crunches',sets:'4',reps:'20 total',rest:45,tempo:'Controlled',notes:'Rotational ab definition. SUB: Standing Cable Oblique Crunch',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Plank to Down Dog (Pike)',sets:'3',reps:'12 reps',rest:45,tempo:'Controlled',notes:'Dynamic core and shoulder stability. SUB: High Plank Hold',equipment:'Mat'},
{phase:'Main Workout',exercise:'Hanging Leg Raises',sets:'3',reps:'10-15',rest:60,tempo:'2011',notes:'Lower ab focus. SUB: Lying Leg Raises',equipment:'Pull-up Bar'},
{phase:'Main Workout',exercise:'Landmine Rotation (Single-Arm)',sets:'3',reps:'12 each side',rest:45,tempo:'2010',notes:'Rotational power with load. SUB: Cable Rotation standing',equipment:'Landmine/Barbell'},
{phase:'Main Workout',exercise:'Copenhagen Plank',sets:'3',reps:'20-30 sec each',rest:45,tempo:'Hold',notes:'Adductor strength and lateral stability. SUB: Side Plank with Leg Lift',equipment:'Bench'},
{phase:'Main Workout',exercise:'Turkish Get-Up (Light Weight)',sets:'3',reps:'3 each side',rest:90,tempo:'Slow',notes:'Full-body coordination and core control. SUB: Windmill Stretch with KB',equipment:'Kettlebell/DB'},
{phase:'Bonus (Optional)',exercise:'Elliptical or Incline Walk',sets:'1',reps:'15 min',rest:0,tempo:'Steady',notes:'Low-impact cardio for recovery. SUB: Incline Walk',equipment:'Elliptical/Treadmill'},
{phase:'Bonus (Optional)',exercise:'Foam Roll Full Body',sets:'1',reps:'10 min',rest:0,tempo:'Slow',notes:'Hit quads, hamstrings, glutes, back, lats, calves. SUB: Static Stretching',equipment:'Foam Roller'},
{phase:'Bonus (Optional)',exercise:'Downward Dog to Cobra Flow',sets:'2',reps:'8 reps',rest:0,tempo:'Flowing',notes:'Full spinal mobility and shoulder stretch. SUB: Cat-Cow',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Pigeon Pose + Supine Figure-4',sets:'1',reps:'90 sec each side',rest:0,tempo:'Hold',notes:'Deep hip opening. SUB: Seated Figure-4 Stretch',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Prone Scorpion Stretch',sets:'1',reps:'10 each side',rest:0,tempo:'Controlled',notes:'Thoracic rotation and hip mobility combination. SUB: Iron Cross Stretch',equipment:'Mat'}
],
Saturday: [
{phase:'Pre-Workout Stretch',exercise:'Sun Salutation Flow (Yoga)',sets:'2',reps:'5 min',rest:0,tempo:'Flowing',notes:'Full body dynamic stretch sequence. SUB: Child\'s Pose Flow',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Hip 90/90 Transition',sets:'2',reps:'10 transitions',rest:0,tempo:'Controlled',notes:'Hip mobility in multiple planes. SUB: Windshield Wipers (seated)',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Thoracic Bridge',sets:'2',reps:'8 reps',rest:0,tempo:'Controlled',notes:'Upper back extension and hip mobility. SUB: Glute Bridge',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Bretzel Stretch',sets:'2',reps:'30 sec each side',rest:0,tempo:'Hold',notes:'Full-body rotational mobility. SUB: Spinal Twist',equipment:'Mat'},
{phase:'Pre-Workout Stretch',exercise:'Wrist and Ankle Mobility',sets:'2',reps:'20 circles each',rest:0,tempo:'Smooth',notes:'Joint prep for lighter accessory work. SUB: Wrist Extensions',equipment:'Bodyweight'},
{phase:'Main Workout',exercise:'Incline Walk or Bike',sets:'1',reps:'20-30 min',rest:0,tempo:'Conversational pace',notes:'Light cardio for blood flow and recovery. SUB: Elliptical',equipment:'Treadmill/Bike'},
{phase:'Main Workout',exercise:'TRX Face Pulls',sets:'3',reps:'15',rest:45,tempo:'Controlled',notes:'Upper back health. SUB: Light Cable Face Pulls',equipment:'TRX/Cable'},
{phase:'Main Workout',exercise:'Banded Lateral Walks',sets:'3',reps:'20 steps each direction',rest:30,tempo:'Controlled',notes:'Glute medius activation. SUB: Side-Lying Leg Raises',equipment:'Resistance Band'},
{phase:'Main Workout',exercise:'Glute Bridge (Bodyweight or Banded)',sets:'3',reps:'20',rest:45,tempo:'2021',notes:'Glute activation and hip extension. SUB: Bird Dog',equipment:'Band/Bodyweight'},
{phase:'Main Workout',exercise:'Dead Bug',sets:'3',reps:'12 each side',rest:30,tempo:'Slow',notes:'Core stability and coordination. SUB: Plank Hold',equipment:'Mat'},
{phase:'Main Workout',exercise:'Banded Pull-Aparts',sets:'3',reps:'20',rest:30,tempo:'Controlled',notes:'Shoulder health and posture. SUB: Scapular Wall Slides',equipment:'Resistance Band'},
{phase:'Main Workout',exercise:'Calf Raises (Bodyweight)',sets:'3',reps:'25',rest:30,tempo:'2012',notes:'Light calf work for recovery. SUB: Seated Calf Raise',equipment:'Bodyweight/Step'},
{phase:'Main Workout',exercise:'Wall Slides',sets:'3',reps:'12',rest:30,tempo:'Slow',notes:'Scapular control and shoulder mobility. SUB: Scapular Shrugs',equipment:'Wall'},
{phase:'Bonus (Optional)',exercise:'Yoga Flexibility Sequence',sets:'1',reps:'15-20 min',rest:0,tempo:'Hold and flow',notes:'Pigeon, Lizard, Half Split, Seated Forward Fold, Supine Twist. SUB: Basic Static Stretch',equipment:'Mat'},
{phase:'Bonus (Optional)',exercise:'Foam Roll Targeted Areas',sets:'1',reps:'10-15 min',rest:0,tempo:'Slow',notes:'Focus on sore areas from week. SUB: Massage Stick',equipment:'Foam Roller'},
{phase:'Bonus (Optional)',exercise:'Lacrosse Ball Foot Release',sets:'1',reps:'3 min each foot',rest:0,tempo:'Pressure',notes:'Plantar fascia mobility for golf stance. SUB: Golf Ball Foot Roll',equipment:'Lacrosse Ball'},
{phase:'Bonus (Optional)',exercise:'Couch Stretch',sets:'1',reps:'90 sec each side',rest:0,tempo:'Hold',notes:'Deep hip flexor stretch. SUB: Standing Quad Stretch',equipment:'Couch/Bench'},
{phase:'Bonus (Optional)',exercise:'Weighted Hang (Decompression)',sets:'1',reps:'60-90 sec',rest:0,tempo:'Passive',notes:'Spinal decompression and grip. SUB: Active Hang',equipment:'Pull-up Bar'}
],
Sunday: [
{phase:'Rest Day',activity:'Complete Rest or Very Light Activity',duration:'N/A',notes:'Primary recovery day - no structured workout'},
{phase:'Optional Activity',activity:'Light Walk (Outdoor if possible)',duration:'20-30 min',notes:'Fresh air and movement without stress'},
{phase:'Optional Activity',activity:'Gentle Yoga or Stretching',duration:'15-20 min',notes:'Focus on breath and relaxation - yin yoga style'},
{phase:'Optional Activity',activity:'Meditation or Breathing Practice',duration:'5-10 min',notes:'Mental recovery and stress management'},
{phase:'Recovery Protocol',activity:'Hydration Focus',duration:'All day',notes:'Drink 100+ oz water, consider electrolytes'},
{phase:'Recovery Protocol',activity:'Nutrition Priority',duration:'All day',notes:'High protein (180-200g), adequate carbs, healthy fats'},
{phase:'Recovery Protocol',activity:'Sleep Goal',duration:'8-9 hours',notes:'Prioritize sleep quality for Monday energy'},
{phase:'Optional',activity:'Golf Practice (Non-Physical)',duration:'30-60 min',notes:'Putting practice, visualization, course management study'},
{phase:'Optional',activity:'Foam Rolling',duration:'10 min',notes:'Full body maintenance rolling - gentle'},
{phase:'Optional',activity:'Contrast Shower',duration:'5 min',notes:'Alternate hot (2 min) and cold (1 min) - end on cold'}
]
};

// ============ EXERCISE DESCRIPTIONS ============
const EX_DESC = {
"World's Greatest Stretch":"Start in a lunge position. Place your inside hand on the ground and rotate your other arm toward the ceiling. This opens your hip flexors, chest, and upper back all at once. Hold each position for about 3 seconds before switching sides.",
"Arm Circles (Forward/Backward)":"Stand tall with arms extended straight out to the sides. Make small circles, gradually increasing to larger circles. Do forward circles, then switch to backward. Warms up the shoulder joints for pressing movements.",
"Cat-Cow Spine Waves":"On all fours, alternate between arching your back (looking up) and rounding your back (tucking chin). Move slowly with your breathinhale on cow (arch), exhale on cat (round). Mobilizes the entire spine.",
"Scapular Wall Slides":"Stand with your back flat against a wall, arms in a 'goalpost' position. Slowly slide your arms up overhead and back down while keeping your back, elbows, and wrists touching the wall. Activates the shoulder blade muscles.",
"Standing Torso Rotations":"Stand with feet shoulder-width apart and arms at chest height. Rotate your upper body side to side in a controlled manner, keeping your hips facing forward. Mimics the golf swing rotation pattern.",
"Incline Chest Press Machine":"Sit in the machine with the seat adjusted so handles are at upper chest level. Press the handles forward and upward until arms are extended, then slowly lower back. The incline angle targets the upper chest.",
"Standing Cable Chest Fly":"Stand between two cable machines set at chest height. With a slight bend in elbows, bring both handles together in front of your chest in a hugging motion. Squeeze your chest at the center, then slowly open back up.",
"Seated Overhead Press Machine":"Sit with back supported, grip the handles at shoulder level. Press straight up overhead until arms are extended, then lower back to shoulder height. Builds shoulder strength for overhead stability.",
"Cable Lateral Raise":"Stand sideways to a low cable, grab the handle with the far hand. Raise your arm out to the side until it's parallel to the floor, then slowly lower. Isolates the middle part of the shoulder.",
"Tricep Rope Pushdown":"Attach a rope to a high cable. Grip the rope with both hands, elbows tucked at your sides. Push down by straightening your arms and spreading the rope apart at the bottom. Slowly return to start.",
"Cable Pallof Press":"Stand sideways to a cable at chest height. Hold the handle at your chest with both hands. Press your arms straight out in front of you, resisting the cable's pull to rotate you. This trains your core to resist rotationessential for golf.",
"Cable Woodchop High-to-Low":"Set a cable at the highest position. Stand sideways, grab the handle with both hands. Pull diagonally across your body from high to low, rotating your torso. Mimics the golf downswing motion.",
"Cable Woodchop Low-to-High":"Set a cable at the lowest position. Stand sideways, grab the handle with both hands. Pull diagonally across your body from low to high, rotating your torso. Mimics the golf backswing motion.",
"Decline Sit-Up or Weighted Crunch":"Hook your feet on a decline bench and lie back. Cross arms over chest or hold a weight plate. Curl your torso up by contracting your abs, then slowly lower back down. The decline angle increases difficulty.",
"Plank with Shoulder Taps":"Get into a push-up position. While keeping your hips as still as possible, lift one hand and tap the opposite shoulder. Alternate sides. This trains your core to resist rotation while maintaining stability.",
"Face Pulls":"Attach a rope to a high cable. Pull toward your face with elbows high and wide, squeezing your shoulder blades together. Pause at your face, then slowly extend back. Great for shoulder health and posture.",
"Incline DB Chest Fly":"Lie on an incline bench with dumbbells above your chest, palms facing each other. Lower the weights out to the sides in a wide arc, feeling a stretch in your chest, then bring them back together overhead.",
"Hanging Knee Raises":"Hang from a pull-up bar with arms extended. Raise your knees toward your chest by contracting your abs, then slowly lower back down. Avoid swingingthe movement should come from your core.",
"Dead Bug":"Lie on your back with arms reaching toward the ceiling and knees bent at 90 degrees. Slowly extend one arm overhead and the opposite leg straight, keeping your lower back pressed to the floor. Return and switch sides.",
"Chest and Shoulder Static Stretch":"Stand in a doorway with your arm against the frame at shoulder height. Step through until you feel a stretch in your chest. Hold for 30-60 seconds. Then cross one arm across your body for a shoulder stretch.",
"90/90 Hip Stretch":"Sit on the floor with one leg bent in front of you at 90 degrees and the other bent behind you at 90 degrees. Lean forward over your front leg to feel a stretch in the hip. This improves both internal and external hip rotation.",
"Standing Quad Stretch with Reach":"Stand on one leg, grab your other ankle behind you. Pull your heel toward your glute while reaching your free arm overhead. This stretches your quad and hip flexor simultaneously while challenging balance.",
"Cossack Squat":"Stand with feet wide apart. Shift your weight to one side, bending that knee deeply while keeping the other leg straight. Go as low as comfortable, then shift to the other side. Opens up the inner thighs and hips.",
"Glute Bridge Pulses":"Lie on your back with knees bent, feet flat on the floor. Push your hips up by squeezing your glutes, creating a straight line from knees to shoulders. Do small pulses at the top to activate the glutes before heavier work.",
"Ankle Circles + Calf Raises":"Circle each ankle 10 times in each direction to mobilize the joint. Then rise up onto your toes slowly and lower back down for calf raises. Prepares the lower legs for squatting and lunging.",
"Leg Press (Feet Mid-Platform)":"Sit in the leg press with feet placed in the middle of the platform, about shoulder width. Push the platform away by extending your legs, then slowly bend your knees to lower it back. Keep your back flat against the pad.",
"Romanian Deadlift (Smith Machine or DB)":"Hold dumbbells or use a Smith machine. Stand tall, then push your hips back while lowering the weight along your legs, keeping a slight bend in your knees. You should feel a strong stretch in your hamstrings. Reverse by squeezing your glutes.",
"Bulgarian Split Squat (DB)":"Hold dumbbells at your sides. Place one foot behind you on a bench. Lower straight down by bending your front knee until your thigh is parallel to the floor. Push back up through your front heel. Builds single-leg strength and balance.",
"Leg Extension Machine":"Sit in the machine with the pad on your shins just above the ankles. Extend your legs by straightening your knees, squeezing your quads at the top. Lower slowly and avoid locking out completely to protect the knee joint.",
"Seated or Lying Leg Curl":"Position yourself so the pad is behind your ankles. Curl your legs by bending your knees, pulling the pad toward your glutes. Squeeze your hamstrings at the top, then slowly extend back. Isolates the hamstrings.",
"Cable Hip Abduction":"Attach an ankle cuff to a low cable. Stand sideways to the machine and lift your outside leg away from your body against the cable's resistance. This targets the glute medius, which stabilizes your hips during the golf swing.",
"Single-Leg Glute Bridge":"Lie on your back with one knee bent and the other leg extended straight. Push through the planted foot to raise your hips, squeezing the glute at the top. Lower slowly. Builds single-leg hip strength.",
"Standing Calf Raises (Smith Machine)":"Stand with the balls of your feet on a raised surface, heels hanging off. Rise up as high as possible onto your toes, hold briefly, then lower your heels below the platform for a full stretch. Use the Smith machine bar for added weight.",
"Copenhagen Plank (or Side Plank)":"Lie on your side with your top leg on a bench and bottom leg underneath. Lift your hips and bottom leg off the ground, creating a straight line. This targets the inner thigh (adductors) and lateral core. Side plank is the easier alternative.",
"Goblet Squat Hold":"Hold a dumbbell at your chest with both hands. Squat down as deep as comfortable and hold the bottom position. Keep your chest up and elbows inside your knees. This builds hip and ankle mobility under load.",
"Step-Ups (DB)":"Hold dumbbells at your sides. Step onto a bench with one foot, driving through that heel to stand up fully. Step back down with control. Builds single-leg power and mimics climbing movements.",
"Seated Hip Flexor Stretch":"Kneel on one knee with the other foot forward. Push your hips forward gently while keeping your torso upright. You should feel a stretch in the front of the hip of your back leg. Hold for 60 seconds each side.",
"Pigeon Pose":"From a push-up position, bring one knee forward toward the same-side wrist, laying the shin on the floor. Extend the back leg straight behind you. Sink your hips toward the floor for a deep hip opener. Hold and breathe.",
"Standing Hamstring Stretch":"Stand tall, extend one leg forward with the heel on the floor and toes pointing up. Hinge at the hips to lean forward with a flat back until you feel a stretch in the back of the extended leg. Hold 45 seconds each side.",
"Thread the Needle (Thoracic Rotation)":"Start on all fours. Reach one arm under your body and through to the other side, lowering your shoulder toward the floor. Then reverse and reach that arm toward the ceiling. This mobilizes the upper back for rotation.",
"Band Pull-Aparts":"Hold a resistance band in front of you at shoulder height with arms extended. Pull the band apart by squeezing your shoulder blades together until the band touches your chest. Slowly return to start.",
"Scapular Shrugs (Hanging or Supported)":"Hang from a pull-up bar with arms fully extended. Without bending your elbows, push your shoulders down and away from your ears by engaging your lats. Then let yourself hang normally. Activates the scapular muscles.",
"Doorway Chest Stretch":"Stand in a doorway with both arms on the door frame at 90 degrees. Step forward through the doorway until you feel a stretch across your chest and front of shoulders. Hold for 30 seconds. Opens up the chest before pulling work.",
"Wrist Circles + Forearm Stretch":"Circle your wrists 10 times in each direction. Then extend one arm forward with palm up, gently pull fingers back with the other hand to stretch the forearm flexors. Switch to palm down for extensors.",
"Lat Pulldown (Wide Grip)":"Sit at the pulldown machine, grip the bar wider than shoulder-width. Pull the bar down to your upper chest by driving your elbows down and back. Squeeze your lats, then slowly let the bar return to the top.",
"Seated Cable Row (Neutral Grip)":"Sit at a cable row station with feet on the platform, knees slightly bent. Pull the handle to your lower chest/upper abdomen by squeezing your shoulder blades together. Slowly extend back. Builds mid-back thickness.",
"Single-Arm Dumbbell Row":"Place one hand and knee on a bench, the other foot on the floor. Hold a dumbbell in the hanging arm. Pull it to your hip by driving your elbow up and back. Lower with control. Builds unilateral back strength.",
"Face Pulls (Rope Attachment)":"Attach a rope to a high cable. Pull toward your face with elbows high, separating the rope ends past your ears. Squeeze your upper back and rear delts at the end position. Excellent for shoulder health and posture.",
"EZ-Bar or Cable Bicep Curl":"Grip an EZ-bar (curved barbell) or cable handle with palms facing up. Curl the weight by bending your elbows, keeping upper arms stationary. Squeeze at the top, then lower slowly. Builds bicep size and strength.",
"Cable Hammer Curl (Rope)":"Attach a rope to a low cable. Grip the rope ends with thumbs up (neutral grip). Curl by bending your elbows while keeping them at your sides. This targets the brachialis muscle and forearms for grip strength.",
"Pallof Press (Isometric Hold)":"Stand sideways to a cable at chest height. Press the handle out in front of you and hold for 20-30 seconds, resisting the cable pulling you into rotation. Keep your abs braced and hips squared. Switch sides.",
"Bird Dog":"Start on all fours with a neutral spine. Simultaneously extend one arm forward and the opposite leg backward. Hold briefly, then return and switch sides. This challenges core stability and spinal control.",
"Russian Twist (Weighted)":"Sit on the floor with knees bent, feet slightly off the ground. Hold a weight at your chest. Rotate your torso from side to side, touching the weight to the floor on each side. Keep your core tight throughout.",
"Straight-Arm Lat Pulldown":"Stand facing a high cable with a straight bar. With arms nearly straight, pull the bar down to your thighs by engaging your lats. Keep a slight bend in the elbows. Slowly return to the top.",
"Farmer's Carry":"Hold heavy dumbbells at your sides. Walk slowly with tall posture, shoulders back, core braced. This builds grip strength, core stability, and total body endurance. Walk for 40-60 seconds per set.",
"Hanging L-Sit Hold":"Hang from a pull-up bar. Raise your legs until they're parallel to the floor, forming an L-shape with your body. Hold this position as long as possible. Strengthens the core and hip flexors.",
"Upper Back and Lat Stretch":"Kneel down and reach your arms forward on the floor (child's pose). Walk your hands to one side to stretch the opposite lat. Also try grabbing a pole and leaning back to stretch the lats.",
"Inchworm to Push-Up":"Stand tall, bend forward and walk your hands out to a push-up position. Do one push-up, then walk your hands back to your feet and stand up. This warms up the whole bodyshoulders, core, hamstrings, and chest.",
"Spiderman Lunge with Rotation":"Step forward into a deep lunge. Place the hand on the same side as your front foot on the ground. Rotate your other arm toward the ceiling. This opens the hip flexors and thoracic spine simultaneously.",
"Hip Hinge Practice (Unweighted)":"Stand with feet hip-width apart. Push your hips back as if closing a car door with your butt, letting your torso lean forward. Keep your back flat and knees slightly bent. Stand back up by squeezing your glutes.",
"Arm Swings (Across Body)":"Stand tall and swing both arms simultaneously across your body, alternating which arm goes on top. This dynamic movement increases blood flow and warms up the chest and shoulder joints.",
"Leg Swings (Forward/Lateral)":"Hold onto something for balance. Swing one leg forward and backward like a pendulum, then side to side. Keep the movement controlled. This warms up the hip joint in all directions.",
"Trap Bar Deadlift or Smith Machine Deadlift":"Stand inside a trap bar or at a Smith machine. Grip the handles, push through your feet to stand up straight. Keep your chest up and back flat throughout. This is a safer deadlift variation that builds total-body power.",
"Goblet Squat (Slow Eccentric)":"Hold a dumbbell at your chest. Squat down slowly (taking 5 seconds to lower) to a deep position. Keep your chest up and knees tracking over toes. Push back up to standing. The slow lowering builds strength and mobility.",
"Single-Leg Romanian Deadlift (DB)":"Hold a dumbbell in one hand. Stand on the opposite leg. Hinge forward at the hips, extending the free leg behind you for balance. Lower the dumbbell toward the floor. Return to standing by squeezing your glute.",
"Landmine Press (or DB Arnold Press)":"Grip the end of a barbell anchored in a corner (landmine). Press it forward and up at an angle. For Arnold Press: hold dumbbells at shoulders with palms facing you, rotate and press overhead. Both build rotational shoulder strength.",
"Cable Row to Rotation":"Sit at a cable row. Pull the handle toward you, then rotate your torso to one side. Return the cable with control. This combines pulling strength with golf-specific rotationgreat for swing power.",
"Medicine Ball Rotational Slam":"Hold a medicine ball at one hip. Rotate explosively and slam it to the opposite side. Mimic your golf swing's power transfer. Pick it up and repeat on the other side. Builds explosive rotational strength.",
"TRX or Suspension Row":"Hold TRX handles, lean back with arms extended and body straight. Pull yourself up by driving your elbows back and squeezing your shoulder blades. Lower slowly. Adjust difficulty by changing your body angle.",
"Ab Wheel Rollout (or Stability Ball)":"Kneel on the floor holding an ab wheel. Roll it forward by extending your arms, letting your body lower toward the floor while keeping your core tight. Pull back to the starting position. Builds anti-extension core strength.",
"Side Plank with Rotation":"Get into a side plank position. Reach your top arm toward the ceiling, then rotate and thread it under your body. Return to the open position. This builds rotational core control and oblique strength.",
"Yoga Flow Sequence":"Move through a flowing sequence: Down Dog, step forward to Low Lunge, rise to Warrior 2, reach forward to Triangle, then back through Down Dog and repeat on the other side. Connects movement with breath.",
"Deep Squat Hold (Goblet)":"Hold a light dumbbell at your chest. Squat as deep as you can and hold at the bottom for 60-90 seconds. Use your elbows to push your knees out. This deeply opens the hips and ankles.",
"Thoracic Extension (Foam Roller)":"Place a foam roller under your upper back. Support your head with your hands. Gently arch backward over the roller, then return to neutral. Roll to different spots along the upper back.",
"Hip 90/90 Stretch (Loaded)":"Sit in the 90/90 position (described above) and place a light dumbbell on your front knee for gentle pressure. Lean forward to deepen the stretch. This enhances hip mobility under mild load.",
"Standing Figure-4 Stretch":"Stand on one leg. Cross the other ankle over the standing knee, creating a figure-4 shape. Sit your hips back as if sitting in a chair. You'll feel a stretch in the glute and outer hip of the crossed leg.",
"Cat-Cow to Child's Pose Flow":"Start on all fours. Flow through cat (round back) and cow (arch back) for a few reps, then sit your hips back toward your heels into child's pose. Reach your arms forward for a lat stretch. Repeat the sequence.",
"Thoracic Rotation (Quadruped)":"On all fours, place one hand behind your head. Rotate that elbow down toward the opposite hand, then open up toward the ceiling. Keep your hips stillthe movement comes from your upper back. Essential for golf swing mobility.",
"Hip Circles (Standing)":"Stand on one leg and draw large circles in the air with the other knee. This mobilizes the hip joint through its full range of motion. Do both directions on each leg.",
"Arm Circles with Torso Lean":"Make arm circles while slightly leaning your torso to one side. This adds an oblique stretch component to the standard shoulder warmup. Switch lean directions to warm up both sides.",
"Marching High Knees":"Stand tall and march in place, bringing each knee as high as comfortable. Drive your opposite arm forward as each knee rises. Activates the hip flexors and core while raising your heart rate.",
"Bicycle Crunches":"Lie on your back with hands behind your head. Bring one knee toward your chest while rotating your opposite elbow to meet it. Extend the other leg straight. Alternate sides in a pedaling motion.",
"Plank to Down Dog (Pike)":"Start in a plank position. Push your hips up and back into a downward dog/pike position, pressing your heels toward the floor. Return to plank. This dynamically challenges core and shoulder stability.",
"Hanging Leg Raises":"Hang from a pull-up bar. Raise your straight legs until they're parallel to the floor or higher. Lower slowly with control. This is an advanced lower ab exercise. Bend knees if straight legs are too difficult.",
"Landmine Rotation (Single-Arm)":"Hold the end of a barbell in one hand at chest height. Rotate your torso to move the barbell in an arc from one side to the other. Keep your hips relatively stable. Builds loaded rotational power.",
"Turkish Get-Up (Light Weight)":"Lie on your back holding a weight straight up with one arm. Stand up while keeping the weight overhead through a series of specific positions: roll to elbow, post to hand, sweep leg, kneel, stand. Reverse to lie back down.",
"Sun Salutation Flow (Yoga)":"A flowing yoga sequence: stand tall, reach overhead, fold forward, step back to plank, lower to floor, cobra, push to down dog, step forward, rise to standing. Warms up the entire body.",
"Hip 90/90 Transition":"Sit with both legs bent at 90 degrees. Rotate both knees to one side, then sweep them to the other side. Your legs transition between internal and external rotation. Builds functional hip mobility.",
"Thoracic Bridge":"Sit on the floor with hands behind you, fingers pointing backward. Lift your hips and reach one arm over and behind you in a rotational bridge. This opens the chest and mobilizes the upper back.",
"Bretzel Stretch":"Lie on your side. Grab your top foot behind you (quad stretch). Rotate your top shoulder toward the floor. This stretch targets the hip flexors, quads, and thoracic spine all at once.",
"Wrist and Ankle Mobility":"Circle your wrists and ankles in both directions. These small joint movements prepare the extremities for gripping and balance work. Spend about 20 circles per joint, each direction.",
"Incline Walk or Bike":"Walk on a treadmill at a moderate incline (5-8%) or ride a stationary bike at low resistance. Keep the pace conversationalyou should be able to talk easily. This is active recovery to promote blood flow.",
"TRX Face Pulls":"Hold TRX handles with palms facing down. Lean back, then pull yourself forward by driving elbows high and wide, rotating hands to face you at the top. Squeeze your upper back. Great for posture.",
"Banded Lateral Walks":"Place a resistance band around your ankles or just above your knees. Get into a slight squat position. Step sideways, keeping tension on the band. This fires up the glute medius for hip stability.",
"Glute Bridge (Bodyweight or Banded)":"Lie on your back with knees bent. Push through your heels to raise your hips, squeezing your glutes at the top. Hold briefly, then lower. Add a band above the knees for extra glute medius activation.",
"Banded Pull-Aparts":"Hold a band at shoulder height with arms extended. Pull the band apart by squeezing your shoulder blades together until the band touches your chest. Control the return. Builds upper back endurance.",
"Calf Raises (Bodyweight)":"Stand on the edge of a step or flat on the floor. Rise up onto your toes as high as possible, then lower slowly. Light bodyweight work for recovery and ankle stability.",
"Wall Slides":"Stand with your back against a wall, arms in a 'goalpost' position. Slowly slide your arms up and down the wall while maintaining contact. This trains scapular control and shoulder mobility.",
"Yoga Flexibility Sequence":"A series of held yoga poses: Pigeon (hip opener), Lizard (deep hip flexor), Half Split (hamstring), Seated Forward Fold (full posterior chain), Supine Twist (spinal rotation). Hold each 60-90 seconds.",
"Foam Roll Targeted Areas":"Slowly roll over sore or tight muscles using a foam roller. Apply moderate pressure and pause on tender spots for 20-30 seconds. Focus on areas that feel tight from the week's training.",
"Lacrosse Ball Foot Release":"Stand with a lacrosse ball under one foot. Roll it along your arch, applying pressure to release the plantar fascia. This is especially beneficial for golfers who spend hours standing and walking the course.",
"Couch Stretch":"Kneel with one knee on the floor, foot pressed against a wall or couch behind you. Step the other foot forward into a lunge. Push your hips forward for an intense hip flexor and quad stretch.",
"Weighted Hang (Decompression)":"Hang from a pull-up bar with arms fully extended, letting your body weight decompress the spine. Relax your shoulders and breathe deeply. This relieves pressure between vertebrae after a week of lifting."
};

// ============ STATE ============
// ============ SUPABASE CLIENT ============
const _sb = supabase.createClient(
  'https://mjxytssjgavwfcypoyti.supabase.co',
  'sb_publishable_O4XRvCgQXMyn1ulMslutdQ_Fdz38KPO'
);

// ============ STATE ============
let state = JSON.parse(localStorage.getItem('wt_state') || '{}');
  if (!state.week) state.week = 1;
  if (!state.dark) state.dark = false;
  if (!state.day) state.day = 'Monday';
  if (!DAYS.includes(state.day)) state.day = 'Monday';
  if (!state.data) state.data = {};
  if (!state.ui) state.ui = {};
  if (!state.ui.phaseCollapsed) state.ui.phaseCollapsed = {};
  if (!state.ui.bwCollapsedDate) state.ui.bwCollapsedDate = '';
  if (!state.activeWorkoutTab) state.activeWorkoutTab = 'pre';
  if (!state.lastAccessedDate) state.lastAccessedDate = '';
  const WEEK_DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  const PROGRAMS = [
    { id: 'golf-6week', name: 'Golf Training 6-Week Cycle', weeks: 6 },
    { id: 'strength-4week', name: 'Strength & Mobility 4-Week', weeks: 4 }
  ];
  if (!state.programId) state.programId = PROGRAMS[0].id;
  if (!state.programStarts) state.programStarts = {};

  // MIGRATION: Move old history/weight logs into state if they exist
  if (!state.history || state.history.length === 0) {
    const oldHistory = JSON.parse(localStorage.getItem('wt_history') || '[]');
    if (oldHistory.length > 0) state.history = oldHistory;
  }
  if (!state.weightLog || state.weightLog.length === 0) {
    const oldWLog = JSON.parse(localStorage.getItem('wt_weight_log') || '[]');
    if (oldWLog.length > 0) state.weightLog = oldWLog;
  }

  let currentSyncKey = localStorage.getItem('wt_sync_key') || null;
  let saveTimeout = null;

  let syncChannel = null;

  async function initSupabase() {
    if (currentSyncKey) {
      updateSyncUI();
      await pullFromCloud();
      subscribeToChanges();
    }
  }

  function subscribeToChanges() {
    if (syncChannel) syncChannel.unsubscribe();
    
    syncChannel = _sb.channel('state-changes')
      .on('postgres_changes', { 
        event: 'UPDATE', 
        schema: 'public', 
        table: 'sync_data', 
        filter: `sync_key=eq.${currentSyncKey}` 
      }, payload => {
        if (payload.new && payload.new.state) {
          // Update local state and re-render only if cloud data is newer
          state = payload.new.state;
          localStorage.setItem('wt_state', JSON.stringify(state));
          renderDay(state.day);
          updateWeekHeader();
          renderTabs();
          showSyncIndicator('success');
        }
      })
      .subscribe();
  }

  let syncIndicatorTimeout = null;

  function showSyncIndicator(type) {
    const indicator = document.getElementById('syncIndicator');
    if (!indicator) return;
    const originalText = currentSyncKey ? currentSyncKey.split('_')[0].toUpperCase() : 'OFFLINE';
    
    clearTimeout(syncIndicatorTimeout);

    if (type === 'syncing') {
      indicator.innerText = "Syncing...";
      indicator.style.opacity = "0.7";
      indicator.style.color = "var(--amber)";
      // Safety timeout: if sync hangs, reset UI after 10s
      syncIndicatorTimeout = setTimeout(() => {
        indicator.innerText = "Retry Sync";
        indicator.style.color = "var(--red)";
      }, 10000);
    } else if (type === 'success') {
      indicator.innerText = "Updated!";
      indicator.style.color = "var(--accent)";
      indicator.style.opacity = "1";
      syncIndicatorTimeout = setTimeout(() => {
        indicator.innerText = originalText;
        indicator.style.color = "";
      }, 2000);
    } else if (type === 'error') {
      indicator.innerText = "Sync Error";
      indicator.style.color = "var(--red)";
      indicator.style.opacity = "1";
      syncIndicatorTimeout = setTimeout(() => {
        indicator.innerText = originalText;
        indicator.style.color = "";
      }, 3000);
    }
  }

  async function pullFromCloud() {
    if (!currentSyncKey) return;
    showSyncIndicator('syncing');
    const { data, error } = await _sb
      .from('sync_data')
      .select('state')
      .eq('sync_key', currentSyncKey)
      .single();
    
    if (data && data.state) {
      // Prune if cloud has old image data
      if (data.state.customDiagrams) {
        delete data.state.customDiagrams;
      }
      state = data.state;
      localStorage.setItem('wt_state', JSON.stringify(state));
      renderDay(state.day);
      updateWeekHeader();
      renderTabs();
      showSyncIndicator('success');
    } else if (error) {
      showSyncIndicator('error');
    }
  }

  async function pushToCloud() {
    if (!currentSyncKey) return;
    showSyncIndicator('syncing');
    
    // PERMANENTLY purge images from local state to stop the bloat
    if (state.customDiagrams) {
      console.log("Migrating images out of main state...");
      delete state.customDiagrams;
      localStorage.setItem('wt_state', JSON.stringify(state));
    }

    try {
      const { error } = await _sb
        .from('sync_data')
        .upsert({ 
          sync_key: currentSyncKey, 
          state: state, // Progress only
          updated_at: new Date().toISOString() 
        });

      if (error) {
        console.error('Cloud Push Error Details:', error.message, error.hint, error.details);
        showSyncIndicator('error');
        // Tell the user exactly what's wrong once
        if (!window._lastSyncError) {
          alert("Sync Error: " + error.message + "\nCheck console for details.");
          window._lastSyncError = true;
        }
      } else {
        showSyncIndicator('success');
        window._lastSyncError = false;
      }
    } catch (e) {
      console.error('Push failed connection:', e);
      showSyncIndicator('error');
    }
  }

  async function uploadDiagramToCloud(exId, base64) {
    if (!currentSyncKey) return;
    console.log("Uploading diagram for:", exId);
    try {
      const { error } = await _sb
        .from('user_diagrams')
        .upsert({ 
          sync_key: currentSyncKey, 
          ex_id: exId,
          image_data: base64,
          updated_at: new Date().toISOString() 
        }, { onConflict: 'sync_key,ex_id' });
      
      if (error) {
        console.error('Diagram Upload Error:', error.message, error.details, error.hint);
        alert("Image too large for cloud. Try a smaller or simpler photo.");
      } else {
        console.log("Diagram uploaded successfully:", exId);
      }
    } catch (e) {
      console.error('Diagram upload failed connection:', e);
    }
  }

  async function fetchDiagramFromCloud(exId) {
    if (!currentSyncKey) return null;
    const { data, error } = await _sb
      .from('user_diagrams')
      .select('image_data')
      .eq('sync_key', currentSyncKey)
      .eq('ex_id', exId)
      .single();
    return data ? data.image_data : null;
  }

  function save() { 
    try {
      localStorage.setItem('wt_state', JSON.stringify(state)); 
    } catch (e) {
      console.warn("Local storage full, relying on cloud sync.");
      showSyncIndicator('error');
      
      // Cleanup attempt for older, potentially larger keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('custom_diagram_')) {
          localStorage.removeItem(key);
        }
      }
    }
    if (currentSyncKey) {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(pushToCloud, 2000);
    }
  }

  function compressImage(base64, maxWidth = 600) {
    return new Promise((resolve) => {
      const img = new Image();
      img.src = base64;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        // Use JPEG with 0.6 quality for small sync-friendly size
        resolve(canvas.toDataURL('image/jpeg', 0.6));
      };
    });
  }

  // Auth UI Handlers
  function openAuth() { document.getElementById('authModal').classList.add('active'); }
  function closeAuth() { document.getElementById('authModal').classList.remove('active'); }
  function toggleAuthMode() {
    // No longer needed for PIN sync, but keeping UI stable
    alert("Just enter your Name and PIN to sync!");
  }

  async function handleAuth() {
    const rawName = document.getElementById('authEmail').value.trim().toLowerCase();
    const rawPin = document.getElementById('authPassword').value.trim();
    if (!rawName || !rawPin) return alert('Name and PIN required');

    const key = `${rawName}_${rawPin}`;

    // Check if data exists in cloud
    const { data, error } = await _sb
      .from('sync_data')
      .select('state')
      .eq('sync_key', key)
      .single();

    if (data) {
      const choice = confirm("Cloud data found for this PIN!\n\nOK: Load Cloud Data (Overwrites this device)\nCancel: Use Local Data (Overwrites Cloud)");
      if (choice) {
        state = data.state;
        localStorage.setItem('wt_state', JSON.stringify(state));
      }
    }
    
    currentSyncKey = key;
    localStorage.setItem('wt_sync_key', key);
    await pushToCloud();
    subscribeToChanges(); // Start listening after login
    updateSyncUI();
    closeAuth();
    if (data) location.reload(); // Refresh if we loaded cloud data
  }

  function signOut() {
    if (!confirm('Stop syncing on this device?')) return;
    currentSyncKey = null;
    localStorage.removeItem('wt_sync_key');
    updateSyncUI();
  }
  function getKey(day, idx) { return `w${state.week}_${day}_${idx}`; }
  function getExState(day, idx) { return state.data[getKey(day, idx)] || { done: false, weight: '', reps: '', collapsed: false, exercise: '', swapped: false }; }
  function setExState(day, idx, val) { state.data[getKey(day, idx)] = val; save(); }

  function getAlternative(notes) {
    if (!notes) return null;
    const match = notes.match(/SUB:\s*([^.]+)/i);
    return match ? match[1].trim() : null;
  }

  function toggleSwap(day, idx) {
    const s = getExState(day, idx);
    const ex = (WORKOUTS[day] || [])[idx];
    if (!getAlternative(ex.notes)) return;
    s.swapped = !s.swapped;
    setExState(day, idx, s);
    renderDay(day);
  }

// ============ UI STATE ============
  const HISTORY_KEY = 'wt_ex_history';
  const UI_TAB_KEY = 'uiActiveTab';
  const HIDE_COMPLETED_KEY = 'hideCompleted';
let uiActiveTab = (localStorage.getItem(UI_TAB_KEY) || 'home').toLowerCase();
if (!['home', 'program', 'history'].includes(uiActiveTab)) uiActiveTab = 'home';
let hideCompleted = JSON.parse(localStorage.getItem(HIDE_COMPLETED_KEY) || 'false');
let showCompletedOverride = false;
let activeWorkoutTab = state.activeWorkoutTab;
let workoutHistory = getWorkoutHistory();

function setActiveTab(tab) {
  uiActiveTab = ['home', 'program', 'history'].includes(tab) ? tab : 'home';
  localStorage.setItem(UI_TAB_KEY, uiActiveTab);
  document.getElementById('homeTabBtn').classList.toggle('active', uiActiveTab === 'home');
  document.getElementById('programTabBtn').classList.toggle('active', uiActiveTab === 'program');
  document.getElementById('historyTabBtn').classList.toggle('active', uiActiveTab === 'history');
  
  document.body.classList.remove('tab-program', 'tab-history');
  if (uiActiveTab === 'program') document.body.classList.add('tab-program');
  if (uiActiveTab === 'history') document.body.classList.add('tab-history');

  if (uiActiveTab === 'program') {
    renderProgram();
  } else if (uiActiveTab === 'history') {
    renderHistory();
  } else {
    renderTabs();
    renderDay(state.day);
  }
}

function renderHistory() {
  const container = document.getElementById('historyArea');
  const history = getWorkoutHistory();
  if (history.length === 0) {
    container.innerHTML = '<div class="program-card"><div class="program-meta">No workout history found. Start training to see your progress!</div></div>';
    return;
  }
  const reversed = [...history].reverse();
  let currentDay = '';
  let html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;"><h2>Exercise History</h2><button class="reset-btn" onclick="clearFullHistory()">Clear History</button></div>';
  reversed.forEach(item => {
    const date = new Date(item.ts);
    const dayLabel = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    if (dayLabel !== currentDay) {
      if (currentDay !== '') html += '</div>';
      html += `<div class="program-card" style="margin-bottom:1rem"><h3>${dayLabel}</h3>`;
      currentDay = dayLabel;
    }
    const category = getExerciseCategory({ exercise: item.exercise });
    const hideInputs = shouldHideLoadInputs(category);
    
    html += `<div style="display:flex;justify-content:space-between;border-bottom:1px solid var(--border);padding:0.5rem 0;">
      <div><strong>${item.exercise}</strong><div style="font-size:0.7rem;color:var(--text3)">${date.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>
      ${hideInputs ? '<div style="font-size:0.75rem;color:var(--accent);font-weight:600;">Completed</div>' : `<div style="font-size:0.85rem">${item.weight || '-'} lbs x ${item.reps || '-'} reps</div>`}
    </div>`;
  });
  html += '</div><div style="text-align:center;margin-top:2rem;"><button class="reset-btn" style="font-size:0.8rem;" onclick="fullReset()">Hard Reset (Wipe All Data)</button></div>';
  container.innerHTML = html;
}

function clearFullHistory() {
  if (!confirm('Are you sure you want to clear ALL exercise history?')) return;
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
}

function fullReset() {
  if (!confirm('CRITICAL: This will wipe ALL progress, history, weight logs, and settings. Are you absolutely sure?')) return;
  localStorage.clear();
  window.location.reload();
}

function shareWorkout() {
  const day = state.day;
  if (day === 'Weight Log') { alert('Select a workout day to share.'); return; }
  const exercises = WORKOUTS[day] || [];
  let text = `My ${day} Workout (Week ${state.week}):\n\n`;
  exercises.forEach(ex => {
    const s = getExState(day, exercises.indexOf(ex));
    text += `- ${ex.exercise}: ${s.done ? '[COMPLETED]' : '[ ]'} ${s.weight ? `${s.weight} lbs x ` : ''}${s.reps || ex.reps}\n`;
  });
  text += '\nShared from Pro Trainer Elite';
  navigator.clipboard.writeText(text).then(() => alert('Workout summary copied to clipboard!'));
}

function setHideCompleted(val) {
  hideCompleted = !!val;
  localStorage.setItem(HIDE_COMPLETED_KEY, JSON.stringify(hideCompleted));
  if (!hideCompleted) showCompletedOverride = false;
  renderDay(state.day);
}

function toggleShowCompleted() {
  showCompletedOverride = !showCompletedOverride;
  renderDay(state.day);
}

function getPhaseKey(day, phase) {
  return `${state.week}|${day}|${phase}`;
}
function isPhaseCollapsed(day, phase) {
  return !!state.ui.phaseCollapsed[getPhaseKey(day, phase)];
}
function togglePhaseCollapse(day, phase) {
  const key = getPhaseKey(day, phase);
  state.ui.phaseCollapsed[key] = !state.ui.phaseCollapsed[key];
  save();
  renderDay(day);
}

function isBwCollapsed() {
  const today = formatLocalISO(new Date());
  return state.ui.bwCollapsedDate === today;
}
function setBwCollapsed(val) {
  const today = formatLocalISO(new Date());
  state.ui.bwCollapsedDate = val ? today : '';
  save();
}

function getDefaultReps(repsText) {
  if (!repsText) return 10;
  const rangeMatch = repsText.match(/(\d+)\s*-\s*(\d+)/);
  if (rangeMatch) {
    const a = parseInt(rangeMatch[1], 10);
    const b = parseInt(rangeMatch[2], 10);
    return Math.round((a + b) / 2);
  }
  const singleMatch = repsText.match(/(\d+)/);
  if (singleMatch) return parseInt(singleMatch[1], 10);
  return 10;
}

const HIDE_LOAD_INPUT_CATEGORIES = new Set(['stretches', 'cardio', 'yoga']);

function getExerciseCategory(exercise) {
  if (!exercise) return 'Strength';
  if (typeof exercise.category === 'string' && exercise.category.trim()) return exercise.category.trim();

  const phase = (exercise.phase || '').toLowerCase();
  const name = (exercise.exercise || '').toLowerCase();
  const notes = (exercise.notes || '').toLowerCase();

  if (phase.includes('stretch') || name.includes('stretch')) return 'Stretches';
  if (name.includes('yoga') || name.includes('pose') || notes.includes('yoga')) return 'Yoga';
  if (name.includes('walk') || name.includes('bike') || name.includes('elliptical') || notes.includes('cardio')) return 'Cardio';
  return 'Strength';
}

function shouldHideLoadInputs(category) {
  return HIDE_LOAD_INPUT_CATEGORIES.has((category || '').toLowerCase());
}

Object.keys(WORKOUTS).forEach(day => {
  WORKOUTS[day] = (WORKOUTS[day] || []).map(item => {
    if (!item || !item.exercise) return item;
    return { ...item, category: getExerciseCategory(item) };
  });
});

function getExerciseId(name) {
  return name
    .toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}
function renderRepsOptions(selected) {
  const opts = [];
  for (let i = 1; i <= 20; i++) opts.push(i);
  [25, 30].forEach(v => opts.push(v));
  return opts.map(v => `<option value="${v}" ${String(selected) === String(v) ? 'selected' : ''}>${v}</option>`).join('');
}

function getActiveProgram() {
  return PROGRAMS.find(p => p.id === state.programId) || PROGRAMS[0];
}
function getActiveProgramId() {
  return state.programId || 'no-program';
}
function getProgramStartISO(id = getActiveProgramId()) {
  return (state.programStarts && state.programStarts[id]) || '';
}
function setProgramStartISO(id, iso) {
  state.programStarts[id] = iso;
  save();
}

function formatLocalISO(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}
function parseLocalISO(iso) {
  const [y, m, d] = iso.split('-').map(Number);
  return new Date(y, m - 1, d);
}
function getViewDateISO(day) {
  const dayIndex = WEEK_DAYS.indexOf(day);
  if (dayIndex < 0) return formatLocalISO(new Date());
  const programId = getActiveProgramId();
  const startISO = getProgramStartISO(programId);
  if (startISO) {
    const start = parseLocalISO(startISO);
    const offset = (state.week - 1) * 7 + dayIndex;
    const viewDate = new Date(start.getFullYear(), start.getMonth(), start.getDate() + offset);
    return formatLocalISO(viewDate);
  }
  const today = new Date();
  const mondayOffset = (today.getDay() + 6) % 7;
  const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - mondayOffset);
  const weekOffset = (state.week - 1) * 7;
  const viewDate = new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + weekOffset + dayIndex);
  return formatLocalISO(viewDate);
}

  // ============ INIT ============
  function init() {
    initSupabase();
    const nowISO = formatLocalISO(new Date());
    const dateChanged = state.lastAccessedDate !== nowISO;
    
    if (dateChanged) {
      state.activeWorkoutTab = 'pre';
      activeWorkoutTab = 'pre';
      state.lastAccessedDate = nowISO;
      const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
      if (WEEK_DAYS.includes(todayName)) {
        state.day = todayName;
      }
    }

    const progress = getProgramProgress();
    if (progress.started && !progress.finished) {
      state.week = progress.week;
      // Only set day if it was a date change, or if we want the program day. 
      // Requirement says reset daily and revert back to pre-workout. 
      // If the user manually switched day, it should stay there until 12am reset.
    } else {
      const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
      if (WEEK_DAYS.includes(todayName) && !state.day) {
        state.day = todayName;
      }
    }
    save();

    document.getElementById('weekSelect').value = state.week;
    if (state.dark) document.body.classList.add('dark');
    renderTabs();
    renderDay(state.day);
    renderProgram();
    updateWeekHeader();
    setActiveTab(uiActiveTab);
  }
  
  function renderTabs() {
    const t = document.getElementById('tabs');
    t.innerHTML = DAYS.map(d => {
      let label = d === 'Weight Log' ? '&#9878; Weight' : d.slice(0, 3);
      const isActive = state.day === d ? ' active' : '';
      let check = '';
      if (d !== 'Sunday' && d !== 'Weight Log' && WORKOUTS[d]) {
        const total = WORKOUTS[d].filter(e => e.phase === 'Main Workout').length;
        const done = WORKOUTS[d].filter((e, i) => e.phase === 'Main Workout' && getExState(d, i).done).length;
        if (total > 0 && done === total) check = '<span class="tab-check">&#10003;</span>';
      }
    return `<button class="tab${isActive}" onclick="switchDay('${d}')">${label}${check}</button>`;
  }).join('');
}

function switchDay(d) { 
  state.day = d; 
  showCompletedOverride = false; 
  // No longer reset tab automatically on day switch if we want "locked in"
  save(); 
  renderTabs(); 
  renderDay(d); 
}

function setWorkoutTab(tabKey) {
  activeWorkoutTab = tabKey;
  state.activeWorkoutTab = tabKey;
  save();
  const tabs = document.querySelectorAll('.workout-tab');
  const sections = document.querySelectorAll('.workout-section');
  tabs.forEach(tab => {
    const isActive = tab.dataset.tab === tabKey;
    tab.classList.toggle('active', isActive);
    tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
  });
  sections.forEach(section => {
    const isActive = section.dataset.section === tabKey;
    section.classList.toggle('active', isActive);
  });
}

function getWorkoutHistory() {
  return state.history || [];
}

function saveWorkoutHistory(list) {
  state.history = list;
  save();
}

function logWorkoutHistory(exercise, weight, reps) {
  if (!exercise) return;
  const w = String(weight || '').trim();
  const r = String(reps || '').trim();
  if (!w && !r) return;
  const entry = { exercise, weight: w, reps: r, ts: new Date().toISOString() };
  const list = getWorkoutHistory();
  list.push(entry);
  saveWorkoutHistory(list);
}

function formatDateOrdinal(d) {
  const day = d.getDate();
  const suffix = day % 10 === 1 && day !== 11 ? 'st'
    : day % 10 === 2 && day !== 12 ? 'nd'
    : day % 10 === 3 && day !== 13 ? 'rd'
    : 'th';
  const month = d.toLocaleDateString('en-US', { month: 'short' });
  return `${month} ${day}${suffix}`;
}

function getLatestHistoryEntry(exercise) {
  const list = getWorkoutHistory().filter(h => h.exercise === exercise);
  if (list.length === 0) return null;
  return list[list.length - 1];
}

async function openExerciseDetail(day, idx) {
  const ex = (WORKOUTS[day] || [])[idx];
  if (!ex) return;
  const s = getExState(day, idx);
  const exName = s.swapped ? getAlternative(ex.notes) : ex.exercise;
  
  const detail = document.getElementById('detailView');
  const content = document.getElementById('detailContent');
  const exId = getExerciseId(exName);
  const how = EX_DESC[exName] || 'No instructions yet.';
  
  // Check local state first, then fetch from cloud if needed
  if (!state.customDiagrams) state.customDiagrams = {};
  let customImg = state.customDiagrams[exId];
  
  // If not in local state, try fetching from dedicated cloud table
  if (!customImg && currentSyncKey) {
    customImg = await fetchDiagramFromCloud(exId);
    if (customImg) {
      state.customDiagrams[exId] = customImg;
      localStorage.setItem('wt_state', JSON.stringify(state));
    }
  }

  const imgSrc = customImg || `assets/diagrams/${exId}-1.png`;

  const history = getWorkoutHistory().filter(h => h.exercise === exName);
  const historyHtml = history.length
    ? `<div class="detail-history">${history.map(h => {
        const d = new Date(h.ts);
        const dateStr = `${formatDateOrdinal(d)}, ${d.getFullYear()}`;
        return `<div class="detail-history-item"><span>${dateStr}</span><span>${h.weight || '-'} lbs</span><span>${h.reps || '-' } reps</span></div>`;
      }).join('')}</div>`
    : `<div class="detail-history-empty">No history yet.</div>`;

  content.innerHTML = `
    <div class="detail-header">
      <button class="detail-back" onclick="closeExerciseDetail()">Back</button>
      <div class="detail-title">${exName}</div>
    </div>
    <div class="detail-card detail-diagram">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.5rem;">
        <h3 style="margin-bottom:0">Visual Guide</h3>
        <div style="display:flex; gap:0.5rem;">
          <button class="ex-toggle" style="background:var(--accent); color:#fff; border:none;" onclick="triggerDiagramUpload('${exId}')">Change</button>
          ${customImg ? `<button class="ex-toggle" style="background:var(--bg3);" onclick="removeCustomDiagram('${exId}', '${day}', ${idx})">Reset</button>` : ''}
        </div>
      </div>
      <img id="detailImg" src="${imgSrc}" alt="${exName}" onerror="this.onerror=null; this.src='assets/diagrams/placeholder.svg';">
    </div>
    <div class="detail-card">
      <h3>How to do this</h3>
      <div class="ex-info-content" style="margin-top:0">${how}</div>
    </div>
    <div class="detail-card">
      <h3>Personal History</h3>
      ${historyHtml}
    </div>`;
  detail.classList.add('active');
  detail.setAttribute('aria-hidden', 'false');
  document.body.classList.add('detail-open');
}

function triggerDiagramUpload(exId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async event => {
      const base64 = event.target.result;
      try {
        const compressed = await compressImage(base64);
        if (!state.customDiagrams) state.customDiagrams = {};
        state.customDiagrams[exId] = compressed;
        save(); // Sync progress

        // Parallel upload to dedicated image table
        uploadDiagramToCloud(exId, compressed);

        const img = document.getElementById('detailImg');
        if (img) img.src = compressed;
        
        const day = state.day;
        const exercises = WORKOUTS[day] || [];
        const idx = exercises.findIndex(ex => getExerciseId(ex.exercise) === exId);
        if (idx !== -1) openExerciseDetail(day, idx);
      } catch (err) {
        console.error("Diagram upload issue:", err);
      }
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

async function removeDiagramFromCloud(exId) {
  if (!currentSyncKey) return;
  await _sb.from('user_diagrams').delete().eq('sync_key', currentSyncKey).eq('ex_id', exId);
}

function removeCustomDiagram(exId, day, idx) {
  if (!confirm('Reset to default diagram?')) return;
  if (state.customDiagrams) delete state.customDiagrams[exId];
  save();
  removeDiagramFromCloud(exId);
  openExerciseDetail(day, idx);
}

function closeExerciseDetail() {
  const detail = document.getElementById('detailView');
  detail.classList.remove('active');
  detail.setAttribute('aria-hidden', 'true');
  document.body.classList.remove('detail-open');
}

function renderDay(day) {
  const c = document.getElementById('content');
  if (day === 'Weight Log') { renderWeightLog(c); updateProgress(day); return; }

  let html = renderTodayWeightPanel();

  if (day === 'Sunday') {
    html += renderSundayHtml();
    c.innerHTML = html;
    updateProgress(day);
    return;
  }

  const exercises = WORKOUTS[day] || [];
  const enhanced = exercises.map((ex, i) => {
    const s = getExState(day, i);
    const category = getExerciseCategory(ex);
    const defaultReps = getDefaultReps(ex.reps);
    const repsVal = s.reps || defaultReps;
    return { ...ex, category, _idx: i, _state: s, _repsVal: repsVal, _defaultReps: defaultReps };
  });
  const completedCount = enhanced.filter(ex => ex._state.done).length;
  const shouldHideCompleted = hideCompleted && !showCompletedOverride;
  const visible = shouldHideCompleted ? enhanced.filter(ex => !ex._state.done) : enhanced;

  let phases = {};
  visible.forEach(ex => { if (!phases[ex.phase]) phases[ex.phase] = []; phases[ex.phase].push(ex); });

  html += `<div class="workout-tabs" role="tablist" aria-label="Workout sections">
    <button class="workout-tab${activeWorkoutTab === 'pre' ? ' active' : ''}" data-tab="pre" id="tab-preworkout" onclick="setWorkoutTab('pre')" aria-selected="${activeWorkoutTab === 'pre' ? 'true' : 'false'}" aria-controls="preWorkoutSection">Pre-Workout Stretches</button>
    <button class="workout-tab${activeWorkoutTab === 'main' ? ' active' : ''}" data-tab="main" id="tab-mainworkout" onclick="setWorkoutTab('main')" aria-selected="${activeWorkoutTab === 'main' ? 'true' : 'false'}" aria-controls="mainWorkoutSection">Main Workout</button>
    <button class="workout-tab${activeWorkoutTab === 'bonus' ? ' active' : ''}" data-tab="bonus" id="tab-bonus" onclick="setWorkoutTab('bonus')" aria-selected="${activeWorkoutTab === 'bonus' ? 'true' : 'false'}" aria-controls="bonusWorkoutSection">Bonus</button>
  </div>`;

  html += `<div class="home-controls">
    <label class="toggle-wrap"><input type="checkbox" ${hideCompleted ? 'checked' : ''} onchange="setHideCompleted(this.checked)"> Hide completed</label>
    ${hideCompleted && completedCount > 0 ? `<button class="show-completed-btn" onclick="toggleShowCompleted()">${showCompletedOverride ? 'Hide completed' : `Show completed (${completedCount})`}</button>` : ''}
  </div>`;

  if (visible.length === 0 && exercises.length > 0) {
    html += `<div class="sunday-card"><p>All exercises are completed.</p></div>`;
  }

  const renderPhaseBlocks = (phaseFilter) => {
    let out = '';
    for (const [phase, exs] of Object.entries(phases)) {
      if (!phaseFilter(phase)) continue;
      const cls = phase.includes('Stretch') ? 'stretch' : phase.includes('Bonus') ? 'bonus' : 'main';
      const icon = cls === 'stretch' ? '&#127939;' : cls === 'main' ? '&#128170;' : '&#11088;';
      const collapsed = isPhaseCollapsed(day, phase) ? ' collapsed' : '';
      out += `<div class="phase${collapsed}">
        <div class="phase-header ${cls}" onclick="togglePhaseCollapse('${day}','${phase.replace(/'/g, '&#39;')}')">
          <span class="phase-title">${icon} ${phase}</span>
          <span class="phase-toggle"><span class="arrow">&#9654;</span> ${isPhaseCollapsed(day, phase) ? 'Expand' : 'Collapse'}</span>
        </div>
        <div class="phase-body">`;
      exs.forEach(ex => {
        const s = ex._state;
        const doneClass = s.done ? ' done' : '';
        const checkedClass = s.done ? ' checked' : '';
        const collapsedClass = s.collapsed ? ' collapsed' : '';
        const toggleOpenClass = s.collapsed ? '' : ' open';
      out += `<div class="ex-card${doneClass}${collapsedClass}${s.swapped ? ' swapped-ui' : ''}" id="card-${ex._idx}" data-idx="${ex._idx}">
          <div class="ex-check${checkedClass}" onclick="toggleEx('${day}',${ex._idx}); event.stopPropagation();" id="check-${ex._idx}">${s.done ? '&#10003;' : ''}</div>
          <div class="ex-body">
            <div class="ex-header">
            <div class="ex-name">
              ${s.swapped ? '<div class="ex-swap-indicator">&#8646; Alternative</div>' : (getAlternative(ex.notes) ? '<div class="ex-swap-indicator" style="color:var(--text3);">&#9733; Sub Available</div>' : '')}
              <div class="ex-name-row">
                <button class="ex-link ex-link-btn" type="button" onclick="openExerciseDetail('${day}',${ex._idx}); event.stopPropagation();">${s.swapped ? getAlternative(ex.notes) : ex.exercise}</button>
                ${(() => {
                  const nameToFind = s.swapped ? getAlternative(ex.notes) : ex.exercise;
                  const last = getLatestHistoryEntry(nameToFind);
                  if (!last) return '';
                  const d = new Date(last.ts);
                  const dateStr = `${formatDateOrdinal(d)}, ${d.getFullYear()}`;
                  const w = last.weight ? `${last.weight} lbs` : '- lbs';
                  const r = last.reps ? `${last.reps} reps` : '- reps';
                  return `<span class="ex-name-preview">- ${dateStr}, ${w} x ${r}</span>`;
                })()}
              </div>
            </div>
              <button class="ex-toggle${toggleOpenClass}" id="toggle-${ex._idx}" onclick="toggleExerciseCollapse('${day}',${ex._idx}); event.stopPropagation();"><span class="arrow">&#9654;</span> ${s.collapsed ? 'Expand' : 'Collapse'}</button>
            </div>
            <div class="ex-details">
              <div class="ex-meta">
                <span class="ex-tag sets">${ex.sets} &times; ${ex.reps}</span>
                ${ex.rest > 0 ? `<span class="ex-tag rest" onclick="timerSet(${ex.rest}); event.stopPropagation();" style="cursor:pointer">${ex.rest}s rest</span>` : ''}
                <span class="ex-tag tempo">${ex.tempo}</span>
              </div>
              <div class="ex-notes">${ex.notes}</div>
              <div class="ex-equip">${ex.equipment}</div>
              ${shouldHideLoadInputs(ex.category) ? '' : `<div class="weight-row">
                <span class="weight-label">Weight:</span>
                <input class="weight-input" type="text" placeholder="lbs" value="${s.weight || ''}" onchange="setWeight('${day}',${ex._idx},'${ex.exercise.replace(/'/g, '&#39;')}',this.value)" onclick="event.stopPropagation()">
                <span class="weight-label">Reps:</span>
                <select class="reps-select" onchange="setReps('${day}',${ex._idx},'${ex.exercise.replace(/'/g, '&#39;')}',this.value)" onclick="event.stopPropagation()">
                  ${renderRepsOptions(ex._repsVal)}
                </select>
              </div>`}
              ${EX_DESC[ex.exercise] ? `
                <span class="ex-info-toggle" onclick="toggleInfo(this); event.stopPropagation();"><span class="arrow">&#9654;</span> How to do this</span>
                <div class="ex-info-box">
                  <div class="ex-info-content">
                    <div style="margin-bottom:0.5rem">${EX_DESC[ex.exercise]}</div>
                    <button class="ex-toggle" style="background:var(--accent); color:#fff; border:none; padding:0.25rem 0.6rem; font-size:0.65rem;" onclick="openExerciseDetail('${day}',${ex._idx}); event.stopPropagation();">View Visual Guide</button>
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>`;
      });
      out += '</div></div>';
    }
    return out;
  };

  const preHtml = renderPhaseBlocks(phase => phase.toLowerCase().includes('stretch'));
  const bonusHtml = renderPhaseBlocks(phase => phase.toLowerCase().includes('bonus'));
  const mainHtml = renderPhaseBlocks(phase => phase === 'Main Workout' || (!phase.toLowerCase().includes('stretch') && !phase.toLowerCase().includes('bonus')));

  html += `<div class="workout-section${activeWorkoutTab === 'pre' ? ' active' : ''}" id="preWorkoutSection" data-section="pre">${preHtml}</div>`;
  html += `<div class="workout-section${activeWorkoutTab === 'main' ? ' active' : ''}" id="mainWorkoutSection" data-section="main">${mainHtml}</div>`;
  html += `<div class="workout-section${activeWorkoutTab === 'bonus' ? ' active' : ''}" id="bonusWorkoutSection" data-section="bonus">${bonusHtml}</div>`;
  c.innerHTML = html;
  setWorkoutTab(activeWorkoutTab);
  updateProgress(day);
  attachSwipeListeners();
}

function attachSwipeListeners() {
  const cards = document.querySelectorAll('.ex-card');
  cards.forEach(card => {
    const idx = parseInt(card.dataset.idx);
    const ex = (WORKOUTS[state.day] || [])[idx];
    if (!ex || !getAlternative(ex.notes)) return;

    let startX = 0, startY = 0, currentX = 0, currentY = 0, isSwiping = false;

    card.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      startY = e.touches[0].clientY;
      currentX = startX;
      currentY = startY;
      isSwiping = true;
      card.classList.add('swiping');
    }, { passive: true });

    card.addEventListener('touchmove', e => {
      if (!isSwiping) return;
      currentX = e.touches[0].clientX;
      currentY = e.touches[0].clientY;
      const diffX = currentX - startX;
      const diffY = currentY - startY;
      
      if (Math.abs(diffX) > Math.abs(diffY)) {
        card.style.transform = `translateX(${Math.max(Math.min(diffX, 100), -100)}px)`;
      }
    }, { passive: true });

    card.addEventListener('touchend', e => {
      if (!isSwiping) return;
      isSwiping = false;
      card.classList.remove('swiping');
      const diffX = currentX - startX;
      const diffY = currentY - startY;
      card.style.transform = '';
      
      if (Math.abs(diffX) >= 50 && Math.abs(diffX) > Math.abs(diffY)) {
        toggleSwap(state.day, idx);
      }
      startX = 0; currentX = 0; startY = 0; currentY = 0;
    });
  });
}

function renderSundayHtml() {
  const items = WORKOUTS.Sunday;
  let html = '';
  let lastPhase = '';
  items.forEach(item => {
    if (item.phase !== lastPhase) {
      const color = item.phase === 'Rest Day' ? 'var(--accent)' : item.phase === 'Recovery Protocol' ? 'var(--blue)' : 'var(--text3)';
      html += `<div style="font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:${color};margin:0.75rem 0 0.35rem">${item.phase}</div>`;
      lastPhase = item.phase;
    }
    html += `<div class="sunday-card"><h3>${item.activity}</h3><p>${item.notes}</p><div class="dur">${item.duration}</div></div>`;
  });
  return html;
}

function getProgramProgress() {
  const program = getActiveProgram();
  const startISO = getProgramStartISO(program.id);
  if (!startISO) return { started: false };
  const start = parseLocalISO(startISO);
  const today = new Date();
  const todayLocal = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const daysSinceStart = Math.floor((todayLocal - start) / 86400000);
  const totalDays = (program.weeks || 0) * 7;
  if (daysSinceStart < 0) return { started: true, startsIn: Math.abs(daysSinceStart), totalDays };
  const capped = Math.min(daysSinceStart, Math.max(totalDays - 1, 0));
  const week = Math.floor(capped / 7) + 1;
  const dayIndex = capped % 7;
  const completedDays = Math.min(Math.max(daysSinceStart, 0), totalDays);
  return { started: true, week, dayName: WEEK_DAYS[dayIndex], dayNumber: dayIndex + 1, completedDays, totalDays, finished: daysSinceStart >= totalDays };
}

function renderProgram() {
  const c = document.getElementById('programArea');
  const program = getActiveProgram();
  const startISO = getProgramStartISO(program.id);
  const startLabel = startISO ? parseLocalISO(startISO).toLocaleDateString() : 'Not started';
  const progress = getProgramProgress();
  let progressText = 'Not started';
  if (progress.started && progress.startsIn) {
    progressText = `Starts in ${progress.startsIn} day${progress.startsIn === 1 ? '' : 's'}`;
  } else if (progress.started) {
    const base = `Week ${progress.week}  Day ${progress.dayNumber} (${progress.dayName})`;
    const completed = progress.totalDays ? `Completed ${progress.completedDays}/${progress.totalDays} days` : '';
    progressText = progress.finished ? (progress.totalDays ? `Completed ${progress.totalDays}/${progress.totalDays} days` : 'Completed') : `${base}${completed ? `  ${completed}` : ''}`;
  }

  let html = `<div class="program-card">
    <h2>Program Management</h2>
    <div class="program-row">
      <select class="program-select" id="programSelect" onchange="changeProgram(this.value)">
        ${PROGRAMS.map(p => `<option value="${p.id}" ${p.id === program.id ? 'selected' : ''}>${p.name}</option>`).join('')}
      </select>
      <button class="program-btn primary" onclick="startProgram()">Start/Resume</button>
      <button class="program-btn" onclick="restartProgram()">Restart</button>
    </div>
    <div class="program-meta"><strong>Active:</strong> ${program.name}</div>
    <div class="program-meta"><strong>Start date:</strong> ${startLabel}</div>
    <div class="program-meta"><strong>Status:</strong> ${progressText}</div>
    <div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;">
       <button class="auth-btn" style="margin-bottom:0" onclick="renderMasterExerciseList()">Browse All Exercises</button>
    </div>
  </div>`;
  const guideHtml = PROGRAM_GUIDES[program.id];
  if (guideHtml) {
    html += `<div class="guide-content" style="margin-top:0.75rem">${guideHtml}</div>`;
  } else {
    html += `<div class="program-card" style="margin-top:0.75rem"><h2>Program Guide</h2><div class="program-meta">No guide available yet.</div></div>`;
  }
  c.innerHTML = html;
}

function renderMasterExerciseList() {
  const c = document.getElementById('programArea');
  const program = getActiveProgram();
  
  let html = `<div class="detail-header">
    <button class="detail-back" onclick="renderProgram()">Back to Program</button>
    <div class="detail-title">All Exercises</div>
  </div>`;
  
  html += `<div class="home-controls">
    <input type="text" id="exSearch" class="auth-input" style="margin-bottom:0" placeholder="Search exercises..." oninput="filterMasterList(this.value)">
  </div>`;

  html += `<div id="masterExList">`;
  const all = [];
  WEEK_DAYS.forEach(day => {
    (WORKOUTS[day] || []).forEach((ex, idx) => {
      if (!ex.exercise) return;
      if (!all.find(a => a.name === ex.exercise)) {
        all.push({ name: ex.exercise, day, idx });
      }
    });
  });

  all.sort((a,b) => a.name.localeCompare(b.name)).forEach(item => {
    html += `<div class="ex-card master-ex-item" data-name="${item.name.toLowerCase()}">
      <div class="ex-body" onclick="openExerciseDetail('${item.day}', ${item.idx})">
        <div class="ex-header" style="border-bottom:none; margin-bottom:0;">
          <div class="ex-name" style="font-size:0.9rem; font-weight:700;">${item.name}</div>
          <div style="font-size:0.65rem; color:var(--text3); font-weight:600;">Found on: ${item.day}</div>
        </div>
      </div>
    </div>`;
  });
  html += `</div>`;
  c.innerHTML = html;
}

function filterMasterList(query) {
  const q = query.toLowerCase();
  document.querySelectorAll('.master-ex-item').forEach(el => {
    const name = el.getAttribute('data-name');
    el.style.display = name.includes(q) ? 'block' : 'none';
  });
}

function changeProgram(id) {
  state.programId = id;
  save();
  renderProgram();
  updateWeekHeader();
}

function startProgram() {
  const programId = getActiveProgramId();
  if (!getProgramStartISO(programId)) {
    setProgramStartISO(programId, formatLocalISO(new Date()));
  }
  renderProgram();
  updateWeekHeader();
}

function restartProgram() {
  const programId = getActiveProgramId();
  if (!confirm('Restart this program from today?')) return;
  setProgramStartISO(programId, formatLocalISO(new Date()));
  state.week = 1;
  state.day = 'Monday';
  save();
  renderTabs();
  renderDay(state.day);
  renderProgram();
  updateWeekHeader();
}

function toggleEx(day, idx) {
  const s = getExState(day, idx);
  s.done = !s.done;
  s.collapsed = s.done ? true : false;
  setExState(day, idx, s);
  renderDay(day);
  renderTabs();
  updateWeekHeader();
}

function toggleExerciseCollapse(day, idx) {
  const s = getExState(day, idx);
  s.collapsed = !s.collapsed;
  setExState(day, idx, s);
  renderDay(day);
}

function setWeight(day, idx, name, val) {
  const s = getExState(day, idx);
  s.weight = val;
  s.exercise = name || s.exercise;
  s.lastUpdated = new Date().toISOString();
  setExState(day, idx, s);
  logWorkoutHistory(s.exercise, s.weight, s.reps);
  save(); // Sync cloud
}

function setReps(day, idx, name, val) {
  const s = getExState(day, idx);
  s.reps = val;
  s.exercise = name || s.exercise;
  s.lastUpdated = new Date().toISOString();
  setExState(day, idx, s);
  logWorkoutHistory(s.exercise, s.weight, s.reps);
  save(); // Sync cloud
}

function toggleInfo(el) {
  el.classList.toggle('open');
  const box = el.nextElementSibling;
  box.classList.toggle('open');
}

function updateProgress(day) {
  if (day === 'Sunday' || day === 'Weight Log') {
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressText').innerText = day === 'Sunday' ? 'Rest Day' : 'Weight Tracker';
    return;
  }
  const exercises = WORKOUTS[day] || [];
  const mainExs = exercises.filter(e => e.phase === 'Main Workout');
  const total = mainExs.length;
  const done = exercises.filter((e, i) => e.phase === 'Main Workout' && getExState(day, i).done).length;
  const pct = total > 0 ? Math.round((done / total) * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').innerText = `${done}/${total} exercises`;
}

function getWeekStartDate() {
  const programId = getActiveProgramId();
  const startISO = getProgramStartISO(programId);
  if (startISO) {
    const start = parseLocalISO(startISO);
    return new Date(start.getFullYear(), start.getMonth(), start.getDate() + (state.week - 1) * 7);
  }
  const today = new Date();
  const mondayOffset = (today.getDay() + 6) % 7;
  const monday = new Date(today.getFullYear(), today.getMonth(), today.getDate() - mondayOffset);
  return new Date(monday.getFullYear(), monday.getMonth(), monday.getDate() + (state.week - 1) * 7);
}

function getWeekCompletionPercent() {
  let total = 0;
  let done = 0;
  WEEK_DAYS.forEach(day => {
    if (day === 'Sunday') return;
    const exs = WORKOUTS[day] || [];
    exs.forEach((ex, i) => {
      if (ex.phase !== 'Main Workout') return;
      total += 1;
      if (getExState(day, i).done) done += 1;
    });
  });
  return total > 0 ? Math.round((done / total) * 100) : 0;
}

function updateWeekHeader() {
  const el = document.getElementById('weekSelect');
  if (!el) return;
  const start = getWeekStartDate();
  const end = new Date(start.getFullYear(), start.getMonth(), start.getDate() + 6);
  const today = new Date();
  const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  el.classList.remove('status-today','status-good','status-mid','status-none','status-future');

  if (todayDate >= start && todayDate <= end) {
    el.classList.add('status-today');
    return;
  }
  if (todayDate < start) {
    el.classList.add('status-future');
    return;
  }
  const pct = getWeekCompletionPercent();
  if (pct >= 75) el.classList.add('status-good');
  else if (pct >= 1) el.classList.add('status-mid');
  else el.classList.add('status-none');
}

function setWeek(w) { state.week = parseInt(w); showCompletedOverride = false; save(); renderTabs(); renderDay(state.day); updateWeekHeader(); }
function toggleDark() { state.dark = !state.dark; document.body.classList.toggle('dark'); save(); document.getElementById('darkToggle').innerHTML = state.dark ? '&#9728;' : '&#9790;'; }
function resetWeek() { const prefix = `w${state.week}_`; Object.keys(state.data).forEach(k => { if (k.startsWith(prefix)) delete state.data[k]; }); save(); renderTabs(); renderDay(state.day); updateWeekHeader(); }

// ============ TIMER ============
let timerSec = 0, timerRunning = false, timerInterval = null;
function timerSet(s) { timerSec = s; timerRunning = false; clearInterval(timerInterval); updateTimerDisplay(); showTimer(); }
function timerStart() {
  if (timerRunning) { timerRunning = false; clearInterval(timerInterval); document.getElementById('timerStartBtn').innerText = 'Start'; return; }
  if (timerSec <= 0) timerSec = 60;
  timerRunning = true;
  document.getElementById('timerStartBtn').innerText = 'Pause';
  timerInterval = setInterval(() => {
    timerSec--;
    updateTimerDisplay();
    if (timerSec <= 0) { clearInterval(timerInterval); timerRunning = false; document.getElementById('timerStartBtn').innerText = 'Start'; try { navigator.vibrate && navigator.vibrate([200, 100, 200]); } catch(e){} }
  }, 1000);
}
function timerReset() { clearInterval(timerInterval); timerSec = 0; timerRunning = false; updateTimerDisplay(); document.getElementById('timerStartBtn').innerText = 'Start'; }
function updateTimerDisplay() { const m = Math.floor(timerSec / 60); const s = timerSec % 60; document.getElementById('timerDisplay').innerText = m + ':' + (s < 10 ? '0' : '') + s; }
function showTimer() { document.getElementById('timerBar').classList.toggle('visible'); }

// ============ PROGRAM GUIDE HTML ============
const GUIDE_HTML = `
<h2>Program Overview</h2>
<p><strong>Duration:</strong> 6-week rotating blocks | <strong>Target:</strong> 35-year-old male golfer, 195 lbs</p>
<p><strong>Goals:</strong> Maintain weight, build lean muscle, rotational power, core strength, flexibility, visible abs</p>
<p><strong>Location:</strong> Planet Fitness | <strong>Training Days:</strong> Mon-Fri (main), Sat (optional), Sun (rest)</p>

<h2>Weekly Schedule</h2>
<ul>
<li><strong>Monday:</strong> Upper Body Push + Rotational Core (60 min + 15-30 min bonus)</li>
<li><strong>Tuesday:</strong> Lower Body + Hip Mobility (60 min + 15-30 min bonus)</li>
<li><strong>Wednesday:</strong> Upper Body Pull + Anti-Rotation Core (60 min + 15-30 min bonus)</li>
<li><strong>Thursday:</strong> Full Body Power + Flexibility Focus (60 min + 15-30 min bonus)</li>
<li><strong>Friday:</strong> Core/Rotational Power + Active Recovery (60 min + 15-30 min bonus)</li>
<li><strong>Saturday:</strong> Optional Mobility &amp; Light Accessory (30-60 min)</li>
<li><strong>Sunday:</strong> Complete Rest + Recovery Protocol</li>
</ul>

<h2>Pre-Workout Routine (Every Day)</h2>
<p>15 min Incline Walk (3.0-3.5 mph, 5-8% incline) + general stretching, then complete day-specific 5-10 min stretch routine. Total warm-up: ~20-25 minutes.</p>

<h2>Tempo Notation</h2>
<p>Format: <strong>[Eccentric]-[Bottom Pause]-[Concentric]-[Top Pause]</strong></p>
<p>Example: <strong>3010</strong> = 3 sec lowering, 0 sec pause, 1 sec lifting, 0 sec pause at top. "Explosive" = move fast with control.</p>

<h2>6-Week Progression Protocol</h2>
<h3>Weeks 1-2: Foundation</h3>
<p>Moderate weight (2-3 more reps possible per set). Focus on form and tempo. Establish baseline.</p>
<h3>Weeks 3-4: Build</h3>
<p>Increase weight 5-10% OR add 1-2 reps. Push closer to failure (1-2 reps in reserve). Maintain strict form.</p>
<h3>Week 5: Peak</h3>
<p>Maximum weight maintaining form. Push to technical failure. May reduce reps to 6-8 on main lifts.</p>
<h3>Week 6: Deload</h3>
<p>Reduce weight 20-30%. Same reps/sets but lighter and faster. Focus on movement quality and mobility.</p>

<h2>Exercise Rotation (After 6 Weeks)</h2>
<ul>
<li>Incline Press &rarr; Flat Press &rarr; Decline Press</li>
<li>Lat Pulldown Wide &rarr; Neutral Grip &rarr; Underhand</li>
<li>Leg Press &rarr; Smith Squat &rarr; Bulgarian Split Squat emphasis</li>
<li>Keep core rotation exercises consistent (golf-specific)</li>
</ul>

<h2>Nutrition Guidelines</h2>
<p><strong>Maintain 195 lbs + Build Muscle</strong></p>
<ul>
<li><strong>Calories:</strong> 2,800-3,000/day</li>
<li><strong>Protein:</strong> 180-200g (0.9-1.0g/lb)</li>
<li><strong>Carbs:</strong> 300-350g</li>
<li><strong>Fats:</strong> 80-90g</li>
<li><strong>Pre-workout:</strong> Carbs + protein 60-90 min before</li>
<li><strong>Post-workout:</strong> 40g protein + 60g carbs within 60 min</li>
<li><strong>Hydration:</strong> 100+ oz water daily, +16-20 oz per hour training</li>
</ul>

<h2>Knee Safety Modifications</h2>
<p>ACL/meniscus history requires these protocols:</p>
<ul>
<li>Always warm up hips, ankles, and knees thoroughly</li>
<li>Keep knees tracking over toes (avoid valgus collapse)</li>
<li>Avoid deep knee flexion under heavy load (stay above 90&deg;)</li>
<li>No jumping, box jumps, or high-impact plyometrics</li>
<li>Stop immediately if knee pain occurs</li>
<li>Prioritize single-leg work for stability</li>
</ul>

<h2>Visible Abs Strategy</h2>
<ol>
<li><strong>Direct Ab Work:</strong> Decline sit-ups, weighted crunches, hanging leg raises (4x/week)</li>
<li><strong>Anti-Rotation Core:</strong> Pallof presses, bird dogs, plank variations</li>
<li><strong>Rotational Power:</strong> Cable woodchops, medicine ball slams, Russian twists</li>
<li><strong>Total Core Integration:</strong> Compound lifts, carries, loaded movements</li>
</ol>
<p><strong>Timeline:</strong> Weeks 1-2 strength gains &rarr; Weeks 3-4 upper ab definition &rarr; Weeks 5-8 visible upper abs &rarr; Weeks 9-12 full six-pack (with diet)</p>

<h2>Flexibility Maintenance</h2>
<p><strong>Daily Priority Stretches:</strong></p>
<ol>
<li>Hip Flexor Stretch (daily) - counteracts sitting, improves swing</li>
<li>Thoracic Rotation (4x/week) - essential for golf rotation</li>
<li>Hamstring Stretch (3x/week) - protects lower back</li>
<li>Lat and Shoulder Stretch (3x/week) - maintains ROM</li>
<li>Pigeon Pose (2x/week) - deep hip opener</li>
</ol>

<h2>Rotational Power Development</h2>
<ul>
<li>Cable Woodchop High-to-Low (downswing pattern)</li>
<li>Cable Woodchop Low-to-High (backswing pattern)</li>
<li>Pallof Press (resist rotation = stability)</li>
<li>Medicine Ball Rotational Slams (explosive power)</li>
<li>Landmine Rotations (loaded rotation)</li>
</ul>
<p><strong>Golf Transfer:</strong> +3-8 mph clubhead speed over 12 weeks, better weight transfer, reduced injury risk.</p>

<h2>Recovery Protocols</h2>
<ul>
<li><strong>Daily:</strong> 8+ hours sleep, 100+ oz water, post-workout nutrition, evening stretching</li>
<li><strong>Weekly:</strong> Sunday rest, Saturday optional, foam rolling 2-3x/week</li>
<li><strong>Warning Signs:</strong> Sharp joint pain, decreased ROM, persistent soreness (>3 days), fatigue, strength regression</li>
</ul>

<h2>FAQ</h2>
<ul>
<li><strong>Cardio?</strong> Low-impact only: incline walking, elliptical, bike, swimming. No running/HIIT.</li>
<li><strong>Missed workout?</strong> Continue next scheduled day. Don't "make up" workouts. After 2+ days off, reduce weight 10%.</li>
<li><strong>Exercise hurts?</strong> Stop immediately. Use listed substitute. If that hurts too, skip and consult a professional.</li>
<li><strong>Bonus work?</strong> Optional. Prioritize the main 60 min workout.</li>
<li><strong>Results timeline?</strong> Strength: 2-3 weeks. Ab definition: 4-6 weeks. Golf performance: 3-4 weeks. Body composition: 6-8 weeks.</li>
</ul>
`;

const PROGRAM_GUIDES = {
  'golf-6week': GUIDE_HTML,
  'strength-4week': `
  <h2>Program Overview</h2>
  <p><strong>Duration:</strong> 4-week block | <strong>Target:</strong> general strength and mobility</p>
  <h2>Weekly Focus</h2>
  <ul>
    <li>2-3 strength sessions</li>
    <li>2 mobility-focused sessions</li>
    <li>1 optional conditioning day</li>
  </ul>
  <h2>Notes</h2>
  <p>Build consistent movement patterns, prioritize recovery, and track your loads weekly.</p>
  `
};

function getLastWeightLabel() {
  const log = getWeightLog();
  if (log.length === 0) return '';
  const last = log[log.length - 1];
  const d = new Date(last.ts);
  return `Last: ${last.weight} lbs (${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})})`;
}

function renderTodayWeightPanel() {
  const collapsed = isBwCollapsed();
  const lastLabel = getLastWeightLabel();
  return `<div class="weight-panel${collapsed ? ' collapsed' : ''}">
    <div class="weight-header">
      <span>Today's Weight</span>
      <button class="weight-toggle" onclick="toggleBwPanel()"><span class="arrow">&#9654;</span> ${collapsed ? 'Expand' : 'Collapse'}</button>
    </div>
    <div class="weight-body">
      <div class="weight-row-inline">
        <input class="weight-input-lg" id="bwInput" type="number" step="0.1" placeholder="lbs">
        <button class="weight-btn" onclick="logBodyWeight()">Log</button>
        <span class="weight-last" id="bwLast">${lastLabel}</span>
      </div>
    </div>
  </div>`;
}

function toggleBwPanel() {
  const next = !isBwCollapsed();
  setBwCollapsed(next);
  renderDay(state.day);
}

// ============ BODY WEIGHT LOG ============
function getWeightLog() { return state.weightLog || []; }
function saveWeightLog(log) {
  state.weightLog = log;
  save();
}

function logBodyWeight() {
  const input = document.getElementById('bwInput');
  const val = parseFloat(input.value);
  if (!val || val < 50 || val > 700) return;
  const log = getWeightLog();
  const now = new Date();
  log.push({ weight: val, ts: now.toISOString() });
  saveWeightLog(log);
  input.value = '';
  setBwCollapsed(true);
  renderDay(state.day);
}

function deleteWeightEntry(idx) {
  const log = getWeightLog();
  log.splice(idx, 1);
  saveWeightLog(log);
  renderDay('Weight Log');
}

let wlogRange = '1w';

function logWeightFromPage() {
  const input = document.getElementById('wlogPageInput');
  const val = parseFloat(input.value);
  if (!val || val < 50 || val > 700) return;
  const log = getWeightLog();
  log.push({ weight: val, ts: new Date().toISOString() });
  saveWeightLog(log);
  input.value = '';
  renderDay('Weight Log');
}

function renderWeightLog(c) {
  const log = getWeightLog();
  
  let html = `<div class="wlog-header">
    <h2 style="font-size:1.1rem">Weight Tracker</h2>
    <div class="wlog-range-btns">
      <button class="wlog-range-btn ${wlogRange==='1w'?'active':''}" onclick="wlogRange='1w';renderDay('Weight Log')">1W</button>
      <button class="wlog-range-btn ${wlogRange==='2w'?'active':''}" onclick="wlogRange='2w';renderDay('Weight Log')">2W</button>
      <button class="wlog-range-btn ${wlogRange==='1m'?'active':''}" onclick="wlogRange='1m';renderDay('Weight Log')">1M</button>
      <button class="wlog-range-btn ${wlogRange==='all'?'active':''}" onclick="wlogRange='all';renderDay('Weight Log')">All</button>
    </div>
  </div>`;

  // Quick Add
  html += `<div class="sunday-card" style="margin-bottom:1rem; padding:0.75rem;">
    <h3 style="margin-bottom:0.5rem; font-size:0.85rem;">Log New Weight</h3>
    <div style="display:flex; gap:0.5rem;">
      <input type="number" id="wlogPageInput" class="weight-input" style="flex:1; height:36px; width:auto !important; border:1px solid var(--border); border-radius:8px;" placeholder="lbs" step="0.1">
      <button class="auth-btn" style="width:auto; padding:0 1rem; margin-bottom:0; height:36px; font-size:0.8rem;" onclick="logWeightFromPage()">Log Weight</button>
    </div>
  </div>`;

  if (log.length === 0) {
    c.innerHTML = html + '<div class="wlog-empty"><p>No weight entries yet.</p></div>';
    return;
  }

  const now = new Date();
  const ranges = { '1w': 7, '2w': 14, '1m': 31, 'all': 99999 };
  const days = ranges[wlogRange] || 7;
  const cutoff = new Date(now.getTime() - days * 86400000);
  const filtered = wlogRange === 'all' ? log : log.filter(e => new Date(e.ts) >= cutoff);
  const display = filtered.length > 0 ? filtered : log;

  // Stats
  const weights = display.map(e => e.weight);
  const current = weights[weights.length - 1];
  const first = weights[0];
  const high = Math.max(...weights);
  const low = Math.min(...weights);
  const avg = (weights.reduce((a, b) => a + b, 0) / weights.length).toFixed(1);
  const change = (current - first).toFixed(1);
  const changeSign = change > 0 ? '+' : '';

  html += `<div class="wlog-stats" style="grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
    <div class="wlog-stat" style="padding:0.5rem;"><div class="val" style="font-size:1.1rem">${current}</div><div class="lbl">Now (lbs)</div></div>
    <div class="wlog-stat" style="padding:0.5rem;"><div class="val" style="font-size:1.1rem">${avg}</div><div class="lbl">Avg</div></div>
    <div class="wlog-stat" style="padding:0.5rem;"><div class="val" style="font-size:1.1rem">${changeSign}${change}</div><div class="lbl">Total</div></div>
    <div class="wlog-stat" style="padding:0.5rem;"><div class="val" style="font-size:1rem">${low}-${high}</div><div class="lbl">Range</div></div>
  </div>`;

  html += `<div class="wlog-stats">
    <div class="wlog-stat"><div class="val">${current}</div><div class="lbl">Current (lbs)</div></div>
    <div class="wlog-stat"><div class="val">${avg}</div><div class="lbl">Average</div></div>
    <div class="wlog-stat"><div class="val">${changeSign}${change}</div><div class="lbl">Change</div></div>
    <div class="wlog-stat"><div class="val">${low} - ${high}</div><div class="lbl">Range</div></div>
  </div>`;

  // Chart
  html += `<div class="wlog-chart"><canvas id="wlogCanvas"></canvas></div>`;

  // Table
  html += `<div class="wlog-table"><table><thead><tr><th>Date & Time</th><th>Weight</th><th>Change</th><th></th></tr></thead><tbody>`;
  const reversed = [...display].reverse();
  reversed.forEach((entry, ri) => {
    const realIdx = log.indexOf(entry);
    const d = new Date(entry.ts);
    const dateStr = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    const timeStr = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const prevIdx = display.length - 1 - ri - 1;
    let changeHtml = '<span class="change-same">--</span>';
    if (prevIdx >= 0) {
      const diff = (entry.weight - display[display.length - 1 - ri - 1 + (display.length - 1 - ri - 1 < display.length - 1 - ri ? 0 : 0)].weight);
      // recalc properly
      const origIdx = display.indexOf(entry);
      if (origIdx > 0) {
        const d2 = (entry.weight - display[origIdx - 1].weight).toFixed(1);
        if (d2 > 0) changeHtml = `<span class="change-up">+${d2}</span>`;
        else if (d2 < 0) changeHtml = `<span class="change-down">${d2}</span>`;
        else changeHtml = `<span class="change-same">0.0</span>`;
      }
    }
    html += `<tr><td>${dateStr} ${timeStr}</td><td><strong>${entry.weight}</strong> lbs</td><td>${changeHtml}</td><td><button class="wlog-delete" onclick="deleteWeightEntry(${realIdx})" title="Delete">&#10005;</button></td></tr>`;
  });
  html += '</tbody></table></div>';

  c.innerHTML = html;

  // Draw chart
  setTimeout(() => drawWeightChart(display), 50);
}

function drawWeightChart(data) {
  const canvas = document.getElementById('wlogCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 160 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '160px';
  ctx.scale(dpr, dpr);
  const W = rect.width, H = 160;
  const pad = { top: 20, right: 15, bottom: 30, left: 45 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const weights = data.map(e => e.weight);
  const minW = Math.floor(Math.min(...weights) - 1);
  const maxW = Math.ceil(Math.max(...weights) + 1);
  const range = maxW - minW || 1;

  const isDark = document.body.classList.contains('dark');
  const textColor = isDark ? '#94a3b8' : '#64748b';
  const gridColor = isDark ? 'rgba(148,163,184,0.1)' : 'rgba(0,0,0,0.06)';
  const lineColor = '#16a34a';
  const dotColor = '#22c55e';
  const fillColor = isDark ? 'rgba(22,163,74,0.15)' : 'rgba(22,163,74,0.1)';

  // Grid lines
  ctx.strokeStyle = gridColor;
  ctx.lineWidth = 1;
  const gridLines = 4;
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (cH / gridLines) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    const val = (maxW - (range / gridLines) * i).toFixed(0);
    ctx.fillStyle = textColor; ctx.font = '10px Inter,sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(val, pad.left - 6, y + 3);
  }

  if (data.length < 2) {
    // Single point
    const x = pad.left + cW / 2;
    const y = pad.top + cH / 2;
    ctx.fillStyle = dotColor;
    ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = textColor; ctx.font = 'bold 11px Inter,sans-serif'; ctx.textAlign = 'center';
    ctx.fillText(weights[0] + ' lbs', x, y - 10);
    return;
  }

  // Plot points
  const points = data.map((e, i) => ({
    x: pad.left + (i / (data.length - 1)) * cW,
    y: pad.top + (1 - (e.weight - minW) / range) * cH
  }));

  // Fill
  ctx.beginPath();
  ctx.moveTo(points[0].x, H - pad.bottom);
  points.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(points[points.length - 1].x, H - pad.bottom);
  ctx.closePath();
  ctx.fillStyle = fillColor;
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.strokeStyle = lineColor; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();

  // Dots
  points.forEach((p, i) => {
    ctx.fillStyle = dotColor;
    ctx.beginPath(); ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2); ctx.fill();
  });

  // X-axis labels
  const labelCount = Math.min(data.length, 7);
  const step = Math.max(1, Math.floor(data.length / labelCount));
  ctx.fillStyle = textColor; ctx.font = '9px Inter,sans-serif'; ctx.textAlign = 'center';
  for (let i = 0; i < data.length; i += step) {
    const d = new Date(data[i].ts);
    const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.fillText(label, points[i].x, H - pad.bottom + 14);
  }
  // Always label last
  if ((data.length - 1) % step !== 0) {
    const d = new Date(data[data.length - 1].ts);
    const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.fillText(label, points[points.length - 1].x, H - pad.bottom + 14);
  }
}

// ============ START ============
init();
if (state.dark) document.getElementById('darkToggle').innerHTML = '&#9728;';
</script>
</body>
</html>

