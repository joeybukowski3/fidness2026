<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workout History</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#f1f5f9;--bg2:#ffffff;--bg3:#f8fafc;--text:#0f172a;--text2:#475569;--text3:#94a3b8;--border:#e2e8f0;--accent:#16a34a;--accent2:#22c55e;--radius:12px;--shadow:0 1px 3px rgba(0,0,0,0.08)}
body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0.8rem 1rem;box-shadow:var(--shadow)}
.header-inner{max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:0.5rem}
.header h1{font-size:1.1rem;font-weight:800}
.back-link{font-size:0.75rem;font-weight:700;color:var(--accent);text-decoration:none}
.back-link:hover{text-decoration:underline}
.content{max-width:900px;margin:0 auto;padding:1rem}
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem}
.subtitle{font-size:0.8rem;color:var(--text2);margin-top:0.2rem}
.chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem;min-height:180px}
.table{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.table table{width:100%;border-collapse:collapse;font-size:0.82rem}
.table th{background:var(--bg3);padding:0.5rem 0.75rem;text-align:left;font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--text3);border-bottom:1px solid var(--border)}
.table td{padding:0.5rem 0.75rem;border-bottom:1px solid var(--border);color:var(--text2)}
.empty{color:var(--text3);text-align:center;padding:2rem}
</style>
</head>
<body>
<div class="header">
  <div class="header-inner">
    <div>
      <h1 id="title">Workout History</h1>
      <div class="subtitle" id="subtitle"></div>
    </div>
    <a class="back-link" href="index.html">Back to Training</a>
  </div>
</div>
<div class="content">
  <div class="card" id="summary"></div>
  <div class="chart" id="chartWrap"><canvas id="chart"></canvas></div>
  <div class="table" id="tableWrap"></div>
</div>

<script>
function getExerciseParam() {
  const params = new URLSearchParams(location.search);
  return params.get('exercise') || '';
}

function getEntries(exercise) {
  const raw = JSON.parse(localStorage.getItem('wt_state') || '{}');
  const data = raw.data || {};
  return Object.keys(data).map(key => ({ key, ...data[key] }))
    .filter(entry => entry.exercise === exercise)
    .filter(entry => entry.lastUpdated)
    .sort((a, b) => new Date(a.lastUpdated) - new Date(b.lastUpdated));
}

function renderSummary(exercise, entries) {
  const summary = document.getElementById('summary');
  if (!exercise) {
    summary.innerHTML = '<div class="empty">Pick a workout from the main page to view history.</div>';
    return;
  }
  if (entries.length === 0) {
    summary.innerHTML = `<div class="empty">No history yet for <strong>${exercise}</strong>.</div>`;
    return;
  }
  const last = entries[entries.length - 1];
  summary.innerHTML = `<strong>${exercise}</strong><div class="subtitle">Last updated: ${new Date(last.lastUpdated).toLocaleString()}</div>`;
}

function renderTable(entries) {
  const wrap = document.getElementById('tableWrap');
  if (entries.length === 0) {
    wrap.innerHTML = '<div class="empty">No history data available.</div>';
    return;
  }
  let html = '<table><thead><tr><th>Date</th><th>Weight</th><th>Reps</th></tr></thead><tbody>';
  entries.slice().reverse().forEach(entry => {
    const dt = new Date(entry.lastUpdated).toLocaleString();
    html += `<tr><td>${dt}</td><td>${entry.weight || '--'}</td><td>${entry.reps || '--'}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}

function drawChart(entries) {
  const canvas = document.getElementById('chart');
  const wrap = document.getElementById('chartWrap');
  if (!canvas || entries.length === 0) {
    wrap.innerHTML = '<div class="empty">No weight data to chart.</div>';
    return;
  }
  const data = entries.filter(e => e.weight && !isNaN(parseFloat(e.weight)));
  if (data.length === 0) {
    wrap.innerHTML = '<div class="empty">No weight data to chart.</div>';
    return;
  }
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = wrap.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = 160 * dpr;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = '160px';
  ctx.scale(dpr, dpr);

  const W = rect.width, H = 160;
  const pad = { top: 20, right: 15, bottom: 30, left: 45 };
  const cW = W - pad.left - pad.right;
  const cH = H - pad.top - pad.bottom;

  const weights = data.map(e => parseFloat(e.weight));
  const minW = Math.floor(Math.min(...weights) - 1);
  const maxW = Math.ceil(Math.max(...weights) + 1);
  const range = maxW - minW || 1;

  ctx.strokeStyle = 'rgba(0,0,0,0.06)';
  ctx.lineWidth = 1;
  const gridLines = 4;
  for (let i = 0; i <= gridLines; i++) {
    const y = pad.top + (cH / gridLines) * i;
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(W - pad.right, y); ctx.stroke();
    const val = (maxW - (range / gridLines) * i).toFixed(0);
    ctx.fillStyle = '#64748b'; ctx.font = '10px Inter,sans-serif'; ctx.textAlign = 'right';
    ctx.fillText(val, pad.left - 6, y + 3);
  }

  const points = data.map((e, i) => ({
    x: pad.left + (i / (data.length - 1)) * cW,
    y: pad.top + (1 - (parseFloat(e.weight) - minW) / range) * cH,
    ts: e.lastUpdated
  }));

  ctx.beginPath();
  ctx.moveTo(points[0].x, H - pad.bottom);
  points.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(points[points.length - 1].x, H - pad.bottom);
  ctx.closePath();
  ctx.fillStyle = 'rgba(22,163,74,0.1)';
  ctx.fill();

  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);
  ctx.strokeStyle = '#16a34a'; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();

  points.forEach(p => {
    ctx.fillStyle = '#22c55e';
    ctx.beginPath(); ctx.arc(p.x, p.y, 3.5, 0, Math.PI * 2); ctx.fill();
  });

  const labelCount = Math.min(points.length, 7);
  const step = Math.max(1, Math.floor(points.length / labelCount));
  ctx.fillStyle = '#64748b'; ctx.font = '9px Inter,sans-serif'; ctx.textAlign = 'center';
  for (let i = 0; i < points.length; i += step) {
    const d = new Date(points[i].ts);
    const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.fillText(label, points[i].x, H - pad.bottom + 14);
  }
  if ((points.length - 1) % step !== 0) {
    const d = new Date(points[points.length - 1].ts);
    const label = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    ctx.fillText(label, points[points.length - 1].x, H - pad.bottom + 14);
  }
}

const exercise = getExerciseParam();
const title = document.getElementById('title');
const subtitle = document.getElementById('subtitle');
if (exercise) {
  title.textContent = `${exercise} History`;
  subtitle.textContent = 'Weight and reps over time';
} else {
  subtitle.textContent = 'Select a workout to view history and graphs';
}
const entries = exercise ? getEntries(exercise) : [];
renderSummary(exercise, entries);
renderTable(entries);
drawChart(entries);
</script>
</body>
</html>
